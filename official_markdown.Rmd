---
title: "Proteome-wide screen for RNA-dependent proteins_Group5_Interphase"
author: "Marie Lulu Salein, Kiren Nadeem, Katharina Lotter "
date: "18 7 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Analysis dataset Interphase

We start by analyzing the HeLa Interphase data set. For later parts of the code (kmeans) we also need to load the markdown of the analysis of the HeLa Mitosis data set. The goal is to identify both RNA-binding and RNA-dependent proteins, properties they have in common and compare our results to data bases. 

```{r}
# Load data set

## Insert own location of data set
## FullDat <- read.table("C:/Dokumente/Uni/FS 4/Data Analysis/RDeeP_HeLa_Interphase.csv", header = TRUE, row.names=1, sep = ";") 
## save(FullDat, file = "FullDat.Rdata")

load("FullDat.Rdata") 
dim(FullDat)
```

The data set has 7086 rows representing the proteins and 150 columns (3 replicates with 25 fractions for both Control and RNase samples).

It is important that all of the values are stored as numerics. If not, this will cause problems in calculations and further analysis. As the data set contains doubles, we ckeck every value for being stored as a double. 

```{r}
sum(apply(FullDat, 2, is.double))
## =150 if all values are doubles
```

As we can see, all values are stored as doubles.

# Data cleanup

Our data clean-up consists of two parts: removing all rows containing all zeros and removing rows where all of the control or the RNase values are zero. In the first step of data cleaning, we look for rows (proteins) that had only zeros. We deleted this row (FHOD3_HUMAN) because it does not contain any information. Thereby, the data set is reduced to 7085 rows.

```{r}

which(rowSums(FullDat==0)==150) ## proteins with all zeros
FullDat = FullDat[-(which(rowSums(FullDat==0)==150)),] ## remove protein with all zeros

```

The data set is very large. To prepare the data for our normalization, we split the data set into smaller data frames, one data frame for each replicate resulting in 6 different data frames.

```{r}
colRep1ctrl = seq(1, 150, 6) ## all columns with measurements from rep1 control sample 
colRep2ctrl = seq(2, 150, 6) ## all columns with measurements from rep2 control sample
colRep3ctrl = seq(3, 150, 6) ## all columns with measurements from rep3 control sample
colRep1rnase = seq(4, 150, 6) ## all columns with measurements from rep1 RNase sample
colRep2rnase = seq(5, 150, 6) ## all columns with measurements from rep2 RNase sample
colRep3rnase = seq(6, 150, 6) ## all columns with measurements from rep3 RNase sample


rep1ctrldat = FullDat[,colRep1ctrl] 
rep2ctrldat = FullDat[,colRep2ctrl]
rep3ctrldat = FullDat[,colRep3ctrl]
rep1rnasedat = FullDat[,colRep1rnase]
rep2rnasedat = FullDat[,colRep2rnase]
rep3rnasedat = FullDat[,colRep3rnase]
```

Three of the six data frames are a part of the control and the RNase experiments respectively. We combine them in order to get one data set for each condition by joining them per column.

```{r}
TripCtrldat = cbind(rep1ctrldat, rep2ctrldat, rep3ctrldat)
TripRnasedat = cbind(rep1rnasedat, rep2rnasedat, rep3rnasedat)
```

Now, we continue with the second step of data cleaning. A protein without any values in either the control or the RNase samples cannot be compared to the other condition, thus giving us no information and can be deleted. 
We transform all zeros into NAs and use is.na to look for rows in which the control or the RNase data frame contain all zeros (NAs). As the data sets have 75 columns, the NAs in a row without a value must sum up to 75. This step results in a data set with 7081 rows (4 proteins less). 

```{r}
remo1 = which(rowSums(is.na(TripCtrldat))==75) 
remo2 = which(rowSums(is.na(TripRnasedat))==75) 
if (length(remo1) != 0 ){
  FullDat = FullDat[-remo1,]
}
if (length(remo2) != 0){
  FullDat = FullDat[-remo1,]
}

```

# Normalization fraction-wise 

For the analysis, it is crucial that the replicates for each condition are comparable. When we look at the data set, we notice that all replicates were performed with different amounts of protein. Therefore, we perform a fraction-wise and protein-wise normalization step. First, we adapt the amount of protein per fraction for the three replicates (Ctrl and RNase separately) to be the mean of the two means lying closest to each other between the three replicates.The aim of this step is to make the three replicates comparable to each other to check for reproducibility later on. For this part we transform the NAs back to zeros.

```{r}
FullDat[is.na(FullDat)] = 0
rep_sum = apply(FullDat, 2, sum)## sum of protein amounts per column

## Ctrl sum fraction-wise before normalization
for (i in colRep1ctrl){
  barplot(rep_sum[i:(i+2)])}

## RNase sum fraction-wise before normalization
for (i in colRep1rnase){
  barplot(rep_sum[i:(i+2)])}

## vector with mean for each fraction, each condition and each replicate (= 150 values)
mean_frac_rep = apply(FullDat, 2, mean)
sd_frac_rep = apply(FullDat,2, sd)

## normalization fraction-wise
col_frac_per_condition = sort(c(colRep1ctrl, colRep1rnase))
mean_rep = vector() ## vector with mean value of two mean values that are closest to each other in each fraction of each condition (comparing mean values of triplicates)

for (i in 1:50){
  a = mean_frac_rep[col_frac_per_condition[i]]
  b = mean_frac_rep[col_frac_per_condition[i]+1]
  c = mean_frac_rep[col_frac_per_condition[i]+2]
  if(abs(a-b) <= abs(b-c) && abs(a-b) <= abs(a-c)){ mean_rep[i] = mean(c(a,b))}
    else if(abs(b-c) < abs(a-b) && abs(b-c) <= abs(a-c)){mean_rep[i] = mean(c(b,c))}
      else{mean_rep[i] = mean(c(a,c))}
}

## normalization to amount of mean values (stored in mean_rep)
FullDat_fracnorm = data.frame(FullDat)
for (i in 1:50) {
  for (j in col_frac_per_condition[i]:(col_frac_per_condition[i]+2)){
    x = mean_rep[i]/mean_frac_rep[j]
    FullDat_fracnorm[,j] = FullDat[,j]*x
    
  }
}



```

# Testing if all fraction-wise sums/means are equal after fraction-wise normalization

```{r}
rep_sum_norm = apply(FullDat_fracnorm, 2, sum)

## Ctrl sum fraction-wise before normalization and visualize protein amount
for (i in colRep1ctrl){
  barplot(rep_sum_norm[i:(i+2)])}

## RNase sum fraction-wise before normalization and visualize protein amount
for (i in colRep1rnase){
  barplot(rep_sum_norm[i:(i+2)])
}

## Ctrl sum fraction-wise after normalization 
rep_mean_norm = apply(FullDat_fracnorm, 2, mean)
for (i in colRep1ctrl){
  barplot(rep_mean_norm[i:(i+2)])}

## RNase sum fraction-wise after normalization
for (i in colRep1rnase) {
  barplot(rep_mean_norm[i:(i+2)])
}
```

Then, we normalize the protein amount to 100 for each protein for every replicate using the apply function and save the resulting values in six different data frames. We multiply every value with 100 devided by the sum of the protein amount of the replicate.

# Normalization protein-wise (per replicate)

```{r}

FullDat = FullDat_fracnorm

rep1ctrlnormData = t(apply(FullDat[, colRep1ctrl], 1, function(x) x/(sum(x)/100)))
rep2ctrlnormData = t(apply(FullDat[, colRep2ctrl], 1, function(x) x/(sum(x)/100)))
rep3ctrlnormData = t(apply(FullDat[, colRep3ctrl], 1, function(x) x/(sum(x)/100)))
rep1rnasenormData = t(apply(FullDat[, colRep1rnase], 1, function(x) x/(sum(x)/100)))
rep2rnasenormData = t(apply(FullDat[, colRep2rnase], 1, function(x) x/(sum(x)/100)))
rep3rnasenormData = t(apply(FullDat[, colRep3rnase], 1, function(x) x/(sum(x)/100)))

rep1ctrlnormDataframe = as.data.frame(rep1ctrlnormData)
rep2ctrlnormDataframe = as.data.frame(rep2ctrlnormData)
rep3ctrlnormDataframe = as.data.frame(rep3ctrlnormData)
rep1rnasenormDataframe = as.data.frame(rep1rnasenormData)
rep2rnasenormDataframe = as.data.frame(rep2rnasenormData)
rep3rnasenormDataframe = as.data.frame(rep3rnasenormData)

tripCtrlnormdat = cbind(rep1ctrlnormDataframe, rep2ctrlnormDataframe, rep3ctrlnormDataframe)
tripRnasenormdat = cbind(rep1rnasenormDataframe, rep2rnasenormDataframe, rep3rnasenormDataframe)

## check if amount == 100; example:
sum(rep1ctrlnormData[1,]) # == 100
```

# Creating batch-effect free data frames

Batch effects are variations in the data caused by technical factors. They are not relevant for the biological question and may even lead to different or false conclusions. Thus, we analyze the data set looking for batch-effects by comparing the values of the three replicates for each fraction and each condition:
If there is a protein that contains two zeros (NA) and one value in a fraction, the value will be set to zero.
If there is a protein showing two values and one zero, the zero is replaced by the mean of the two others.

```{r}
## Converting zeros into NAs
tripRnasenormdat[tripRnasenormdat==0] = NA
tripCtrlnormdat[tripCtrlnormdat==0] = NA

for(i in 1:nrow(tripCtrlnormdat)){
  for (j in 1:25){
    testctrl = c(tripCtrlnormdat[i,j],tripCtrlnormdat[i,j+25], tripCtrlnormdat[i,j+50])
    if(sum(is.na(testctrl))==2) {
      cat("\n", i, j)
      tripCtrlnormdat[i, j] = NA
      tripCtrlnormdat[i, j+25] = NA
      tripCtrlnormdat[i, j+50] = NA
    }
    if(sum(is.na(testctrl))==1){
      cat("\n", i, j)
      tripCtrlnormdat[i, j] = mean(testctrl, na.rm = TRUE)
      tripCtrlnormdat[i, j+25] = mean(testctrl, na.rm = TRUE)
      tripCtrlnormdat[i, j+50] = mean(testctrl, na.rm = TRUE)
    }
  }
}

for(i in 1:nrow(tripRnasenormdat)){
  for (j in 1:25){
    testrnase = c(tripRnasenormdat[i,j],tripRnasenormdat[i,j+25], tripRnasenormdat[i,j+50])
    if(sum(is.na(testrnase))==2) {
      tripRnasenormdat[i, j] = NA
      tripRnasenormdat[i, j+25] = NA
      tripRnasenormdat[i, j+50] = NA
    }
    if(sum(is.na(testctrl))==1){
      tripRnasenormdat[i, j] = mean(testrnase, na.rm = TRUE)
      tripRnasenormdat[i, j+25] = mean(testrnase, na.rm = TRUE)
      tripRnasenormdat[i, j+50] = mean(testrnase, na.rm = TRUE)
    }
  }
}

## deleting new rows with all zeros in RNase or Ctrl due to batch effect removal
na_r = which(rowSums(is.na(tripRnasenormdat))==75)
na_c = which(rowSums(is.na(tripCtrlnormdat))==75)
na_afterbatch = c(na_r, na_c)

if (length(na_afterbatch) != 0) {tripCtrlnormdat = tripCtrlnormdat[-na_afterbatch,]}
if (length(na_afterbatch) != 0) {tripRnasenormdat = tripRnasenormdat[-na_afterbatch,]}
if (length(na_afterbatch) != 0) {FullDat = FullDat[-na_afterbatch,]}

## Converting zeros back to NAs for further analysis
tripRnasenormdat[is.na(tripRnasenormdat)] = 0
tripCtrlnormdat[is.na(tripCtrlnormdat)] = 0

rep1ctrlnormDataframe = tripCtrlnormdat[,1:25]
rep2ctrlnormDataframe = tripCtrlnormdat[,26:50]
rep3ctrlnormDataframe = tripCtrlnormdat[,51:75]
rep1rnasenormDataframe = tripRnasenormdat[,1:25]
rep2rnasenormDataframe = tripRnasenormdat[,26:50]
rep3rnasenormDataframe = tripRnasenormdat[,51:75]


```
There are 23 proteins that have a replicate value being a batch effect defined by our criteria.

# Reproducibility

It is crucial to verify that the data is reproducible. Our approach is to compare the maxima (global and local) between the replicates. We determine that maxima are allowed to differ one fraction to be reproducible.

# Global maxima

```{r}   
## global maxima with which.max return the highest value in the row (protein)
fraction_abs_max = data.frame(row.names = rownames(rep1ctrlnormDataframe))
for (i in 1:nrow(rep1ctrlnormDataframe)){
  fraction_abs_max[i,1] = which.max(rep1ctrlnormDataframe[i,])
  fraction_abs_max[i,2] = which.max(rep2ctrlnormDataframe[i,])
  fraction_abs_max[i,3] = which.max(rep3ctrlnormDataframe[i,])
  fraction_abs_max[i,4] = which.max(rep1rnasenormDataframe[i,])
  fraction_abs_max[i,5] = which.max(rep2rnasenormDataframe[i,])
  fraction_abs_max[i,6] = which.max(rep3rnasenormDataframe[i,])
}
## fraction_abs_max: data frame where global values are stored for each protein and each replicate (first column -> first replicate ctrl, second column -> second replicate ctrl...)

## verifying if global maximum shifts more than one fraction between the replicates (TRUE means they do not, thus reproducible)
isTRUE(all.equal(fraction_abs_max[,1], fraction_abs_max[,2], tolerance = 1.1))
isTRUE(all.equal(fraction_abs_max[,2], fraction_abs_max[,3], tolerance = 1.1))
isTRUE(all.equal(fraction_abs_max[,1], fraction_abs_max[,3], tolerance = 1.1))
isTRUE(all.equal(fraction_abs_max[,4], fraction_abs_max[,5], tolerance = 1.1))
isTRUE(all.equal(fraction_abs_max[,5], fraction_abs_max[,6], tolerance = 1.1))
isTRUE(all.equal(fraction_abs_max[,4], fraction_abs_max[,6], tolerance = 1.1))
## all global maxima are reproducible
```
# Local maxima

Definition local maxima: Each of the two values right and the two values left next to the maximum are smaller than the value of the maximum and the local maximum consists of at least 3,5 or 7% of the whole protein amount of the specific protein.

For the marginal values we only look at the existing values next to them. For example for the first fraction we only compare the protein amounts in the two fractions right to fraction 1. We had to specially implement conditions for the marginal values.

```{r}

## Threshold 3 % of total protein amount
## control
maxctrl1_3 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)
maxctrl2_3 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)
maxctrl3_3 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)

for (i in 1:nrow(rep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 3 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)]){
      maxctrl1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 3 &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)]){
      maxctrl2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 3 &&  rep3ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)]){
      maxctrl3_3[i,j] = j
    }
  }
 
  for(j in 2){ ## marginal value 2
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 3 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+2)]){
      maxctrl1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 3 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)]){
      maxctrl2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 3 && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+2)]){
      maxctrl3_3[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 3 && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+2)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-2)]) {
      maxctrl1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 3 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-2)]){
      maxctrl2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i, j] > 3 &&  rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+2)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-2)]) {
      maxctrl3_3[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 3 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-2)]){
      maxctrl1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 3 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-2)]){
      maxctrl2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 3 && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-2)]){
      maxctrl3_3[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 3 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)]){
      maxctrl1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 3 &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)]){
      maxctrl2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 3 &&  rep3ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)]){
      maxctrl3_3[i,j] = j
    }
  }
}


## RNase
maxrnase1_3 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)
maxrnase2_3 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)
maxrnase3_3 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)

for (i in 1:nrow(rep1rnasenormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 3 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)]){
      maxrnase1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 3 &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)]){
      maxrnase2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 3 &&  rep3rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)]){
      maxrnase3_3[i,j] = j
    }
  }
 
  for(j in 2){ ## marginal value 2
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 3 &&  rep1rnasenormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+2)]){
      maxrnase1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 3 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+2)]){
      maxrnase2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 3 && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+2)]){
      maxrnase3_3[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 3 && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+2)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-2)]) {
      maxrnase1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 3 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-2)]){
      maxrnase2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i, j] > 3 &&  rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+2)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-2)]) {
      maxrnase3_3[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 3 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-2)]){
      maxrnase1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 3 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-2)]){
      maxrnase2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 3 && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-2)]){
      maxrnase3_3[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 3 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)]){
      maxrnase1_3[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 3 &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)]){
      maxrnase2_3[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 3 &&  rep3rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)]){
      maxrnase3_3[i,j] = j
    }
  }
}


## Threshold 5 % of total protein amount
## control
maxctrl1_5 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)
maxctrl2_5 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)
maxctrl3_5 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)

for (i in 1:nrow(rep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 5 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)]){
      maxctrl1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 5 &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)]){
      maxctrl2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 5 &&  rep3ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)]){
      maxctrl3_5[i,j] = j
    }
  }

  for(j in 2){ ##marginal value 2
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 5 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+2)]){
      maxctrl1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 5 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)]){
      maxctrl2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 5 && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+2)]){
      maxctrl3_5[i,j] = j
    }
  }

  for (j in 3:23){
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 5 && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+2)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-2)]) {
      maxctrl1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 5 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-2)]){
      maxctrl2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i, j] > 5 &&  rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+2)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-2)]) {
      maxctrl3_5[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 5 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-2)]){
      maxctrl1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 5 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-2)]){
      maxctrl2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 5 && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-2)]){
      maxctrl3_5[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 5 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)]){
      maxctrl1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 5 &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)]){
      maxctrl2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 5 &&  rep3ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)]){
      maxctrl3_5[i,j] = j
    }
  }
}


## RNase
maxrnase1_5 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)
maxrnase2_5 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)
maxrnase3_5 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)

for (i in 1:nrow(rep1rnasenormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 5 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)]){
      maxrnase1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 5 &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)]){
      maxrnase2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 5 &&  rep3rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)]){
      maxrnase3_5[i,j] = j
    }
  }
 
  for(j in 2){ ## marginal value 2
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 5 &&  rep1rnasenormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+2)]){
      maxrnase1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 5 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+2)]){
      maxrnase2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 5 && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+2)]){
      maxrnase3_5[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 5 && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+2)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-2)]) {
      maxrnase1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 5 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-2)]){
      maxrnase2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i, j] > 5 &&  rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+2)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-2)]) {
      maxrnase3_5[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 5 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-2)]){
      maxrnase1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 5 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-2)]){
      maxrnase2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 5 && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-2)]){
      maxrnase3_5[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 5 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)]){
      maxrnase1_5[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 5 &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)]){
      maxrnase2_5[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 5 &&  rep3rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)]){
      maxrnase3_5[i,j] = j
    }
  }
}


## Threshold 7 % of total protein amount
maxctrl1_7 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)
maxctrl2_7 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)
maxctrl3_7 = matrix(0, nrow=nrow(rep1ctrlnormDataframe), ncol=25)

for (i in 1:nrow(rep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 7 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)]){
      maxctrl1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 7 &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)]){
      maxctrl2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 7 &&  rep3ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)]){
      maxctrl3_7[i,j] = j
    }
  }
  
  for(j in 2){ ## marginal value 2
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 7 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+2)]){
      maxctrl1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 7 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)]){
      maxctrl2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 7 && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+2)]){
      maxctrl3_7[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 7 && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+2)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-2)]) {
      maxctrl1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 7 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-2)]){
      maxctrl2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i, j] > 7 &&  rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+2)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-2)]) {
      maxctrl3_7[i,j] = j
    }
  }
  
  
  for(j in 24){ ## marginal value 3
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 7 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-2)]){
      maxctrl1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 7 && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+1)] &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-2)]){
      maxctrl2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 7 && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j+1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-1)] && rep3ctrlnormDataframe[i,j] > rep3ctrlnormDataframe[i, (j-2)]){
      maxctrl3_7[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != fraction_abs_max[i,1] && rep1ctrlnormDataframe[i,j] > 7 &&  rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)]){
      maxctrl1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,2] && rep2ctrlnormDataframe[i,j] > 7 &&  rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j-1)]){
      maxctrl2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,3] && rep3ctrlnormDataframe[i,j] > 7 &&  rep3ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)]){
      maxctrl3_7[i,j] = j
    }
  }
}


## RNase
maxrnase1_7 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)
maxrnase2_7 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)
maxrnase3_7 = matrix(0, nrow=nrow(rep1rnasenormDataframe), ncol=25)

for (i in 1:nrow(rep1rnasenormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 7 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)]){
      maxrnase1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 7 &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)]){
      maxrnase2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 7 &&  rep3rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)]){
      maxrnase3_7[i,j] = j
    }
  }
 
  for(j in 2){ ## marginal value 2
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 7 &&  rep1rnasenormDataframe[i,j] > rep1ctrlnormDataframe[i, (j-1)] && rep1ctrlnormDataframe[i,j] > rep1ctrlnormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+2)]){
      maxrnase1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 7 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+2)]){
      maxrnase2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 7 && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+2)]){
      maxrnase3_7[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 7 && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+2)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-2)]) {
      maxrnase1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 7 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] && rep2ctrlnormDataframe[i,j] > rep2ctrlnormDataframe[i, (j+2)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-2)]){
      maxrnase2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i, j] > 7 &&  rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+2)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-2)]) {
      maxrnase3_7[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 7 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j+1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)] && rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-2)]){
      maxrnase1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 7 && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j+1)] &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)] && rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-2)]){
      maxrnase2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 7 && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j+1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-1)] && rep3rnasenormDataframe[i,j] > rep3rnasenormDataframe[i, (j-2)]){
      maxrnase3_7[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != fraction_abs_max[i,4] && rep1rnasenormDataframe[i,j] > 7 &&  rep1rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)]){
      maxrnase1_7[i,j] = j
    }
    if(j != fraction_abs_max[i,5] && rep2rnasenormDataframe[i,j] > 7 &&  rep2rnasenormDataframe[i,j] > rep2rnasenormDataframe[i, (j-1)]){
      maxrnase2_7[i,j] = j
    }
    if(j != fraction_abs_max[i,6] && rep3rnasenormDataframe[i,j] > 7 &&  rep3rnasenormDataframe[i,j] > rep1rnasenormDataframe[i, (j-1)]){
      maxrnase3_7[i,j] = j
    }
  }
}

## Now we have three data sets for the different thresholds which contain only zeros except on the positions where we found a maximum.

## Comparison thresholds
## matrix that is TRUE if local maximum shifted at least two fractions, otherwise FALSE
compare_max = function(a,b){
vgl = matrix(FALSE, ncol = 25, nrow = nrow(rep1ctrlnormDataframe))
row.names(vgl) = rownames(rep1ctrlnormDataframe)
truesum = vector()
for (i in 1:nrow(vgl)){
  
  for (j in 1) {
    if(a[i,j]==b[i,j]){
      
    } else if(a[i,j]==0 && b[i,j]!=0){
        if(a[i,(j+1)] != 0){
        }
          else {vgl[i,j] = TRUE}
      }
      else if(a[i,j]!=0 && b[i,j]==0){
        if(b[i,(j+1)] != 0){
        }
           else {vgl[i,j] = TRUE}
      }
  }
  
  for (j in 2:24){
    if(a[i,j]==b[i,j]){
      
    } else if(a[i,j]==0 && b[i,j]!=0){
        if(a[i,(j+1)] != 0 || a[i,(j-1)] != 0){
        }
          else {vgl[i,j] = TRUE}
      }
      else if(a[i,j]!=0 && b[i,j]==0){
        if(b[i,(j+1)] != 0 || b[i,(j-1)] != 0){
        }
           else {vgl[i,j] = TRUE}
      }
  }
  
  for (j in 25) {
    if(a[i,j]==b[i,j]){
      
    } else if(a[i,j]==0 && b[i,j]!=0){
        if(a[i,(j-1)] != 0){
        }
          else {vgl[i,j] = TRUE}
      }
      else if(a[i,j]!=0 && b[i,j]==0){
        if(b[i,(j-1)] != 0){
        }
           else {vgl[i,j] = TRUE}
      }
  }
  
  truesum[i] = sum(vgl[i,]) 
}

return(truesum)
}

## compare_max returns vector that tells for each protein how many maxima are more than one fraction different between the compared data frames

compare_max(maxctrl2_3, maxctrl3_3)
comp_rep = function(a,b,c){

rows_rep = vector()
rows_rep = compare_max(a, b)
rows_rep = cbind(rows_rep, compare_max(a,c))
rows_rep = cbind(rows_rep, compare_max(b,c))
row.names(rows_rep) = rownames(rep1ctrlnormDataframe)

return(rows_rep)
}

## matrix with number of at least one fraction local maxima differences for comparison of each of two replicates out of three (different thresholds of total protein amount 3%, 5%, 7%)
loc_max_ctrl3 = as.data.frame(comp_rep(maxctrl1_3, maxctrl2_3, maxctrl3_3))
loc_max_ctrl5 = as.data.frame(comp_rep(maxctrl1_5, maxctrl2_5, maxctrl3_5))
loc_max_ctrl7 = as.data.frame(comp_rep(maxctrl3_3, maxctrl3_5, maxctrl3_7))
loc_max_rnase3 = as.data.frame(comp_rep(maxrnase1_3, maxrnase2_3, maxrnase3_3))
loc_max_rnase5 = as.data.frame(comp_rep(maxrnase1_5, maxrnase2_5, maxrnase3_5))
loc_max_rnase7 = as.data.frame(comp_rep(maxrnase1_7, maxrnase2_7, maxrnase3_7))


## counting proteins that show at least one fraction shift when comparing all replicates in Ctrl and/or RNase 
not_repro = function(a,b) {
  u = vector()
  for (i in 1:nrow(loc_max_ctrl3)) {
    if ((a[i,1] != 0 && a[i,2] != 0 && a[i,3] != 0) || (b[i,1] != 0 && b[i,2] != 0 && b[i,3] != 0)){
      u[i] = TRUE
      }
          else {u[i] = FALSE}
  }
return(u)
}

  
thres_3 = not_repro(loc_max_ctrl3, loc_max_rnase3)
sum(thres_3) ## we would remove 502 proteins with threshold 3%
thres_5 = not_repro(loc_max_ctrl5, loc_max_rnase5)
sum(thres_5) ## we would remove 411 proteins with threshold 5%
thres_7 = not_repro(loc_max_ctrl7, loc_max_rnase7)
sum(thres_7) ## we would remove 365 proteins with threshold 7%

## We decide to go with the definition that the maximum has to contain at least 5% of total protein amount
## remove proteins that are not reproducible from all data sets
FullDat = FullDat[- which(thres_5 == TRUE),]
rep1ctrlnormDataframe = rep1ctrlnormDataframe[- which(thres_5 == TRUE),]
rep2ctrlnormDataframe = rep2ctrlnormDataframe[- which(thres_5 == TRUE),]
rep3ctrlnormDataframe = rep3ctrlnormDataframe[- which(thres_5 == TRUE),]
rep1rnasenormDataframe = rep1rnasenormDataframe[- which(thres_5 == TRUE),]
rep2rnasenormDataframe = rep2rnasenormDataframe[- which(thres_5 == TRUE),]
rep3rnasenormDataframe = rep3rnasenormDataframe[- which(thres_5 == TRUE),]

tripCtrlnormdat = tripCtrlnormdat[- which(thres_5==TRUE),]
tripRnasenormdat = tripRnasenormdat[- which(thres_5==TRUE),]

```

# Mean curves

The next step is taking the mean of all three replicates for each condition to receive an average curve of the protein's distribution with and without RNase. Our normalization has the advantage that all values of the resulting curve sum up to 100. Thus, they are interpretable as percentages.  

```{r}
## mean of control replicates of all proteins  
meanRepctrl = matrix(nrow= nrow(FullDat), ncol = 25)
for (j in 1:nrow(FullDat)){ 
  for (i in 1:25){
    meanRepctrl[j,i] = (rep1ctrlnormDataframe[j,i] + rep2ctrlnormDataframe[j,i] + rep3ctrlnormDataframe[j,i])/3}}

## mean of RNase replicates of all proteins 
meanRepRNase = matrix(nrow= nrow(FullDat), ncol = 25)
for (j in 1:nrow(FullDat)){ 
  for (i in 1:25){
    meanRepRNase[j,i] = (rep1rnasenormDataframe[j,i] + rep2rnasenormDataframe[j,i] + rep3rnasenormDataframe[j,i])/3}}


```

Now we have two curves for the two conditions. Our goal is to determine the maxima and find out which proteins are shifting. This is why we plot the two curves of RNase (pink) and control (blue) in one graph. As we can see, the graphs of the first 10 proteins does not show a shift. 

```{r} 
y = 1:25

for (i in 1:10){
  plot(y, meanRepctrl[i,], type ="o", pch = 20, ylab = "percentage of protein amount", xlab = "fractions of sucrose density gradient", col = "cyan")
  lines(y,meanRepRNase[i,], type = "o", pch = 20, col = "magenta")
}

```
# Maxima for mean Ctrl and mean RNase values

Both local and global maxima of the average curves are calculated as described in the reproducibility part.

# Global maxima

```{r}
## calculate global maxima
abs_max = data.frame(row.names = rownames(rep1ctrlnormDataframe))

for (i in 1:nrow(rep1ctrlnormDataframe)){
  abs_max[i,1] = which.max(meanRepctrl[i,])
  abs_max[i,2] = which.max(meanRepRNase[i,])
  
}

abs_max$compare = ifelse(abs(abs_max$V1-abs_max$V2) > 1, TRUE, FALSE)
sum(abs_max$compare)
## there are 1118 proteins whose global maximum shifts at least 2 fractions (x-shift)
abs_max_shift = rownames (abs_max) [abs_max$compare==TRUE] ## proteins x-shifting in global maximum

```

## Local maxima

```{r}

## calculate local maxima

max_shift_ctrl = matrix(0, nrow = nrow(rep1ctrlnormDataframe), ncol = 25)
max_shift_rnase = matrix(0, nrow = nrow(rep1ctrlnormDataframe), ncol = 25)

for (i in 1:nrow(rep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != abs_max[i,1] && meanRepctrl[i,j] > 5 &&  meanRepctrl[i,j] > meanRepctrl[i, (j+1)]){
      max_shift_ctrl[i,j] = j
    }
    if(j != abs_max[i,2] && meanRepRNase[i,j] > 5 && meanRepRNase[i,j] > meanRepRNase[i, (j+1)]){
      max_shift_rnase[i,j] = j
    }
  }

  for(j in 2){ ## marginal value 2
    if(j != abs_max[i,1] && meanRepctrl[i,j] > 5 &&  meanRepctrl[i,j] > meanRepctrl[i, (j-1)] && meanRepctrl[i,j] > meanRepctrl[i, (j+1)] && meanRepctrl[i,j] > meanRepctrl[i, (j+2)]){
      max_shift_ctrl[i,j] = j
    }
    if(j != abs_max[i,2] && meanRepRNase[i,j] > 5 && meanRepRNase[i,j] > meanRepRNase[i, (j-1)] &&  meanRepRNase[i,j] > meanRepRNase[i, (j+1)] && meanRepRNase[i,j] > meanRepRNase[i, (j+2)]){
      max_shift_rnase[i,j] = j
    }
  }

  for (j in 3:23){
    if(j != abs_max[i,1] && meanRepctrl[i,j] > 5 && meanRepctrl[i,j] > meanRepctrl[i, (j-1)] && meanRepctrl[i,j] > meanRepctrl[i, (j+1)] && meanRepctrl[i,j] > meanRepctrl[i, (j+2)] && meanRepctrl[i,j] > meanRepctrl[i, (j-2)]) {
      max_shift_ctrl[i,j] = j
    }
    if(j != abs_max[i,2] && meanRepRNase[i,j] > 5 && meanRepRNase[i,j] > meanRepRNase[i, (j-1)] && meanRepRNase[i,j] > meanRepRNase[i, (j+1)] && meanRepRNase[i,j] > meanRepRNase[i, (j+2)] && meanRepRNase[i,j] > meanRepRNase[i, (j-2)]){
      max_shift_rnase[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != abs_max[i,1] && meanRepctrl[i,j] > 5 &&  meanRepctrl[i,j] > meanRepctrl[i, (j+1)] && meanRepctrl[i,j] > meanRepctrl[i, (j-1)] && meanRepctrl[i,j] > meanRepctrl[i, (j-2)]){
      max_shift_ctrl[i,j] = j
    }
    if(j != abs_max[i,2] && meanRepRNase[i,j] > 5 && meanRepRNase[i,j] > meanRepRNase[i, (j+1)] &&  meanRepRNase[i,j] > meanRepRNase[i, (j-1)] && meanRepRNase[i,j] > meanRepRNase[i, (j-2)]){
      max_shift_rnase[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != abs_max[i,1] && meanRepctrl[i,j] > 5 &&  meanRepctrl[i,j] > meanRepctrl[i, (j-1)]){
      max_shift_ctrl[i,j] = j
    }
    if(j != abs_max[i,2] && meanRepRNase[i,j] > 5 &&  meanRepRNase[i,j] > meanRepRNase[i, (j-1)]){
      max_shift_rnase[i,j] = j
    }
  }
}

count_shift = compare_max(max_shift_ctrl, max_shift_rnase)
length(which(count_shift ==0))
loc_max_shift = rownames(rep1ctrlnormDataframe)[which(count_shift!=0)]

## compare x-shifts in absolute and local maxima as there are proteins shifting in both

id = vector()
for (i in 1:length(loc_max_shift)) {
  j = 1
  for(j in 1:length(abs_max_shift)){
    if(loc_max_shift[i]!=abs_max_shift[j]){
      id[i] = FALSE
    }
      else if (loc_max_shift[i]==abs_max_shift[j]) {
        id[i] = TRUE
        break
      }
  }
}

sum(id) ## 910 proteins are both found in absolute and local maxima shifts
loc_max_shift = loc_max_shift[- which(id==TRUE)] ## loc_max_shift are all proteins shifting in local maximum excluded those also shifting in global maximum

## number of shifting proteins
sum(id)+(length(abs_max_shift)-sum(id))+length(loc_max_shift) ## 2479 proteins have a shift and might be RNA-binding or RNA-dependent

```
We find 2471 proteins shifting in their global and/or local maxima. In the following, we test if the shift in protein amount is significant which would result in classifying the protein as an RNA-binding or RNA-dependent protein. 

# t-test of shift of protein amount for maximum verification (y-shift)

# Global maxima

```{r}
## calculate global maxima
abs_max_yc = vector()
abs_max_yr = vector()

## two vectors (Ctrl/RNase) containing the y-value (protein amount) of the global maximum
for (i in 1:nrow(abs_max)) {
  abs_max_yc[i] = meanRepctrl[i, abs_max[i,1]]
  abs_max_yr[i] = meanRepRNase[i, abs_max[i,2]]
}
## add vectors as new columns to global maxima data frame (abs_max)
abs_max$ymaxc = abs_max_yc
abs_max$ymaxr = abs_max_yr

## vector l contains p-value for each global maximum with a shift (abs_max[i,3] == TRUE), otherwise random number larger than1 for distinction
l = vector()
for (i in 1:nrow(abs_max)) { 
  if(abs_max[i,3]==TRUE) {
    fc = abs_max[i,1]
    l[i] = t.test(c(tripCtrlnormdat[i,fc], tripCtrlnormdat[i, (fc+25)], tripCtrlnormdat[i, (fc+50)]), c(tripRnasenormdat[i,fc], tripRnasenormdat[i, (fc+25)], tripRnasenormdat[i, (fc+50)]), alternative = "two.sided")$p.value
  }
    else {l[i] = 10} ## random value chosen larger than 1
}

abs_max$pvalue = l
abs_max$sign = ifelse(abs_max$pvalue >= 0.025, FALSE, TRUE) ## 0.025 due to two-sided t-test
sum(abs_max$sign) ## how many proteins have a significant shift in protein amount in their global maximum (869 out of 1118)

colnames(abs_max)[1] = "global_max_ctrl"
colnames(abs_max)[2] = "global_max_rnase"
proteins_global_shift = data.frame(abs_max[(which(abs_max$sign == TRUE)),]) ## dataframe containing all proteins that shift in global maximum before fdr-correction

## create new column containing fdr-corrected p-value
proteins_global_shift$p_adjusted = p.adjust(proteins_global_shift$pvalue, method = "fdr")
proteins_global_shift$sign_ad = ifelse(proteins_global_shift$p_adjusted >= 0.025, FALSE, TRUE)
sum(proteins_global_shift$sign_ad) ## all 869 proteins with shift identified are still significant after fdr-correction

## create new column containing information about right or left shift (difference of Ctrl and RNase global maxima fraction)
proteins_global_shift$leftorright = ifelse(proteins_global_shift$global_max_ctrl < proteins_global_shift$global_max_rnase, "right", "left")

```

# Local maxima

```{r}

## calculate local maxima
## Generate matrices for statistical testing of local maxima 
p_loc_max = matrix(10, ncol = 25, nrow = nrow(rep1ctrlnormDataframe)) ## matrix for adjusted p-values
row.names(p_loc_max) = rownames(rep1ctrlnormDataframe)
p_loc_shift = vector(length = nrow(rep1ctrlnormDataframe)) ## vector distinguishing significant or not significant y-shift
sign_loc_shiftc = matrix(0, ncol = 25, nrow = nrow(rep1ctrlnormDataframe)) ## matrix for fractions of shifting local maxima
sign_loc_shiftr = matrix(0, ncol = 25, nrow = nrow(rep1ctrlnormDataframe)) ## matrix for fractions of shifting local maxima

for (i in 1:nrow(p_loc_max)) {
  if(count_shift[i] > 0){  
    for (j in 1) {
      if(max_shift_ctrl[i,j] == max_shift_rnase[i,j]){
          
      } else if(max_shift_ctrl[i,j]==0 && max_shift_rnase[i,j]!=0){
          if(max_shift_ctrl[i,(j+1)] != 0){
          }
            else {
              sign_loc_shiftr[i,j] = j
              p_loc_max[i,j] = t.test(c(tripCtrlnormdat[i,j], tripCtrlnormdat[i, (j+25)], tripCtrlnormdat[i, (j+50)]), c(tripRnasenormdat[i,j], tripRnasenormdat[i, (j+25)], tripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value 
              p_loc_max[i,j] = p.adjust(p_loc_max[i,j], method = "fdr")
              if(p_loc_max[i,j] < 0.025) { p_loc_shift[i]=TRUE }
              }
        }
        else if(max_shift_ctrl[i,j]!=0 && max_shift_rnase[i,j]==0){
          if(max_shift_rnase[i,(j+1)] != 0){
          }
             else {
               sign_loc_shiftc[i,j] = j
               p_loc_max[i,j] = t.test(c(tripCtrlnormdat[i,j], tripCtrlnormdat[i, (j+25)], tripCtrlnormdat[i, (j+50)]), c(tripRnasenormdat[i,j], tripRnasenormdat[i, (j+25)], tripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
               p_loc_max[i,j] = p.adjust(p_loc_max[i,j], method = "fdr")
               if(p_loc_max[i,j] < 0.025) { p_loc_shift[i]=TRUE }
                 }
        }
    }
    
    for (j in 2:24){
      if(max_shift_ctrl[i,j]==max_shift_rnase[i,j]){
         
      } else if(max_shift_ctrl[i,j]==0 && max_shift_rnase[i,j]!=0){
          if(max_shift_ctrl[i,(j+1)] != 0 || max_shift_ctrl[i,(j-1)] != 0){
          }
            else {
              sign_loc_shiftr[i,j] = j
              p_loc_max[i,j] = t.test(c(tripCtrlnormdat[i,j], tripCtrlnormdat[i, (j+25)], tripCtrlnormdat[i, (j+50)]), c(tripRnasenormdat[i,j], tripRnasenormdat[i, (j+25)], tripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
              p_loc_max[i,j] = p.adjust(p_loc_max[i,j], method = "fdr")
              if(p_loc_max[i,j] < 0.025) { p_loc_shift[i]=TRUE }
            }
        }
        else if(max_shift_ctrl[i,j]!=0 && max_shift_rnase[i,j]==0){
          if(max_shift_rnase[i,(j+1)] != 0 || max_shift_rnase[i,(j-1)] != 0){
          }
             else {
               sign_loc_shiftc[i,j] = j
               p_loc_max[i,j] = t.test(c(tripCtrlnormdat[i,j], tripCtrlnormdat[i, (j+25)], tripCtrlnormdat[i, (j+50)]), c(tripRnasenormdat[i,j], tripRnasenormdat[i, (j+25)], tripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
               p_loc_max[i,j] = p.adjust(p_loc_max[i,j], method = "fdr")
               if(p_loc_max[i,j] < 0.025) { p_loc_shift[i]=TRUE }
             }
        }
    }
    
    for (j in 25) {
      if(max_shift_ctrl[i,j]==max_shift_rnase[i,j]){
          
      } else if(max_shift_ctrl[i,j]==0 && max_shift_rnase[i,j]!=0){
          if(max_shift_ctrl[i,(j-1)] != 0){
          }
            else {
              sign_loc_shiftr[i,j] = j
              p_loc_max[i,j] = t.test(c(tripCtrlnormdat[i,j], tripCtrlnormdat[i, (j+25)], tripCtrlnormdat[i, (j+50)]), c(tripRnasenormdat[i,j], tripRnasenormdat[i, (j+25)], tripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
              p_loc_max[i,j] = p.adjust(p_loc_max[i,j], method = "fdr")
              if(p_loc_max[i,j] < 0.025) { p_loc_shift[i]=TRUE }
            }
        }
        else if(max_shift_ctrl[i,j]!=0 && max_shift_rnase[i,j]==0){
          if(max_shift_rnase[i,(j-1)] != 0){
          }
             else {
               sign_loc_shiftc[i,j] = j
               p_loc_max[i,j] = t.test(c(tripCtrlnormdat[i,j], tripCtrlnormdat[i, (j+25)], tripCtrlnormdat[i, (j+50)]), c(tripRnasenormdat[i,j], tripRnasenormdat[i, (j+25)], tripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
               p_loc_max[i,j] = p.adjust(p_loc_max[i,j], method = "fdr")
               if(p_loc_max[i,j] < 0.025) { p_loc_shift[i]=TRUE }
             }
        }
    }
  }    
}

## p_loc_shift if TRUE: y-shift in local maximum is significant

p_loc_max = as.data.frame(p_loc_max) ## data frame with all 10 only at shifting position adjusted p-value
p_loc_max$count = count_shift
proteins_local_shift = p_loc_max[which(p_loc_shift==TRUE),] ## proteins that shift in local maximum
dim(proteins_local_shift) ## 1471 proteins shift in local maximum
proteins_local_shift = cbind(rownames(proteins_local_shift), proteins_local_shift)
colnames(proteins_local_shift)[1] = "protein"


proteins_global_shift = cbind(rownames(proteins_global_shift), proteins_global_shift)
colnames(proteins_global_shift)[1] = "protein"
proteins_both_shift = merge(proteins_global_shift, proteins_local_shift, by = "protein") ## data sets merged by protein names (column "protein")
proteins_both_shift = proteins_both_shift[,-(11:36)]
dim(proteins_both_shift) ## 687 proteins shift in both global and local maximum
proteins_shifting = merge(proteins_global_shift, proteins_local_shift, by = "protein", all = TRUE) ## 1653 proteins have a shift in either local and/or global maximum

proteins_shifting = proteins_shifting[,-(12:36)]

proteins_shifting$glo_loc = ifelse(is.na(proteins_shifting[,11]), "only local", "global")
proteins_shifting$sign_ad[is.na(proteins_shifting$sign_ad)] = 0
proteins_shifting$count[is.na(proteins_shifting$count)] = 0
proteins_shifting$count_shift = ifelse(proteins_shifting$sign_ad == 1, (proteins_shifting$count +1), proteins_shifting$count)

#install.packages(dplyr) if necessary
library(dplyr)
proteins_only_global = anti_join(proteins_global_shift, proteins_both_shift, by = "protein") 
nrow(proteins_only_global) ## 182 proteins only shift in global maximum
proteins_only_local = anti_join(proteins_local_shift, proteins_both_shift, by = "protein") 
nrow(proteins_only_local) ## 784 proteins only shift in local maximum

```

# Data set preparation for  k-means

```{r}

## build overview data frame with possibly useful information of previous analysis

## vectors with numbers of maxima
numb_max_ctrl = rowSums(max_shift_ctrl!=0)+1 ## +1 -> plus global maximum
numb_max_rnase = rowSums(max_shift_rnase!=0)+1 ## +1 -> plus global maximum

## add to abs_max data frame
abs_max$max_ctrl = numb_max_ctrl
abs_max$max_rnase = numb_max_rnase
abs_max$left_right = ifelse(p_loc_shift == TRUE | abs_max$sign == TRUE, "shift", "no shift") 

overview = cbind(abs_max[, c(1,2,3,4,5,7,8,9,10)], count_shift, p_loc_shift)
colnames(overview)[3] = "x.shift.glo" ## TRUE/FALSE significant x-shift in global maximum
colnames(overview)[6] = "y.shift.glo" ## TRUE/FALSE significant y-shift in global maximum
colnames(overview)[9] = "no.shift?" ## "shift" or "no shift"
colnames(overview)[10] = "count.x.shift.loc" ## how many local maxima shifts
colnames(overview)[11] = "y.shift.loc" ## TRUE/FALSE significant y-shift at least one local maximum

#xxxxxxxxxxx ymaxc, ymaxr, max_ctrl, max_rnase?


overview$x.shift.loc = ifelse(overview$count.x.shift.loc != 0, TRUE, FALSE) ## significant x-shift in local maximum
overview$x.loc.glo = ifelse(overview$x.shift.glo == TRUE & overview$x.shift.loc == TRUE, TRUE, FALSE) ## TRUE/FALSE significant x-shift in global and/or local maximum
overview$y.loc.glo = ifelse(overview$y.shift.glo == TRUE & overview$y.shift.loc == TRUE, TRUE, FALSE) ## TRUE/FALSE significant y-shift in global and/or local maximum

## "right" if right shift in global maximum, "left" if left shift in global maximum, "shift" if shift only in local maximum, "no shift" if no shift
overview$left.right = ifelse(overview$x.shift.glo == TRUE & overview$global_max_ctrl - overview$global_max_rnase > 0, "left", "no shift") 
overview$left.right = ifelse(overview$left.right != "left" & overview$x.shift.glo == TRUE & overview$global_max_ctrl - overview$global_max_rnase < 0, "right", overview$left.right)
overview$left.right = ifelse(overview$x.shift.glo == FALSE & overview$x.shift.loc == TRUE, "shift", overview$left.right)
overview$x.shift.frac.glo = overview$global_max_ctrl - overview$global_max_rnase ## difference in fraction of global maximum between control and RNase

## Compute correlation between Ctrl and RNase mean curve for each protein and store in cor_merge
cor_merge = vector()
for(i in 1:nrow(meanRepctrl)){
  cor_merge[i] = cor(meanRepctrl[i,], meanRepRNase[i,])
}
overview$corr = cor_merge
cors_merge = vector()

## Compute euclidean distance between all values of mean Ctrl and RNase and store highest distance in eucli_merge
eucli_merge = vector()
eu = matrix(0,ncol = ncol(meanRepctrl), nrow = nrow(meanRepctrl))
for (i in 1:nrow(meanRepctrl)) {
  for (j in 1:ncol(meanRepctrl)) {
    eu[i,j] = sqrt((meanRepctrl[i,j] - meanRepRNase[i,j])^2)
  }
}
eucli_merge = apply(eu,1, which.max)
overview$eucli = eucli_merge


overview$protein = rownames(overview) ## Create column with protein names
overview$count.shift = ifelse(overview$x.shift.glo == TRUE, overview$count.x.shift.loc + 1, overview$count.x.shift.loc) ## number of shifting maxima

## preparation: data frames are merged between mitosis and interphase data set
merge_overview = merge(overview, overview_mi, by = "protein") 
```

# k-means

By using k-means we aim at identifying specific groups within the data sets. We look for clusters of proteins when clustering the difference in fraction of global maximum in Ctrl and RNase of interphase with the difference in fraction of global maximum in Ctrl and RNase of mitosis. The idea of this approach is that proteins might be assigned to the same cluster if shifting in a similar way/ not in a similar way.

```{r}
## k-means
## load and install packages

library(factoextra)
library(ggplot2)

## Create matrix for first clustering: difference in fraction of global maximum in Ctrl and RNase of interphase clustered with difference in fraction of global maximum in Ctrl and RNase of mitosis
kmeans_data1 = cbind((merge_overview$global_max_rnase-merge_overview$global_max_ctrl), (merge_overview$m.global_max_rnase-merge_overview$m.global_max_ctrl)) 

## elbow plot
elbowdata1 = fviz_nbclust(kmeans_data1, kmeans, method = "wss") + labs(subtitle = "Elbow method")
## elbow plot would suggest rather 4 than 5 clusters but for the biological question the results of 5 clusters are more significant

## Perform k-means and visualize clusters
km.out1 = kmeans(kmeans_data1, centers = 5, nstart = 100, iter.max = 20)
km.clusters1 = km.out1$cluster
clusterdata1 = fviz_cluster(km.out1, data = as.data.frame(kmeans_data1) , geom = "point")
clusterdata1

## compare clusters with right/left/shift/no shift column
table(km.clusters1, merge_overview$left.right)
table(km.clusters1, merge_overview$m.left.right)

## adding difference in maxima for mitosis and interphase as additional variables
kmeans_data2 = cbind((merge_overview$global_max_rnase-merge_overview$global_max_ctrl), (merge_overview$m.global_max_rnase-merge_overview$m.global_max_ctrl), (merge_overview$ymaxc-merge_overview$ymaxr), (merge_overview$m.ymaxc-merge_overview$m.ymaxr)) 

## elbow plot
elbowdata2 = fviz_nbclust(kmeans_data2, kmeans, method = "wss") + labs(subtitle = "Elbow method")

km.out2 = kmeans(kmeans_data2, centers = 4, nstart = 100, iter.max = 20)
km.clusters2 = km.out2$cluster
clusterdata2 = fviz_cluster(km.out2, data = as.data.frame(kmeans_data2) , geom = "point")
clusterdata2

table(km.clusters2, merge_overview$left.right)
table(km.clusters2, merge_overview$m.left.right)

## no improvement in cluster structure due to additional variable
```
xxxx xxxxxx 

# Regression analysis

```{r}
library(ggplot2)

## split data set into training (80 % of total data set) and test data set (20 %)
set.seed(1)
section = sample(1:nrow(merge_overview), 0.8 * nrow(merge_overview))

## train data set
train_data = merge_overview[section,]

train_data$x.shift.frac.glo = abs(train_data$x.shift.frac.glo)

## test data set
test_data = merge_overview[-section,]
test_data$x.shift.frac.glo = abs(test_data$x.shift.frac.glo)

## output variable: how many fractions does the global maximum of the protein shift? (x.shift.frac.glo)
## take multiple input variables: difference in number of maxima, pearson correlation

# pearson correlation
plot(x.shift.frac.glo ~ corr, data = train_data)
cor(train_data$x.shift.frac.glo, train_data$corr) ## sollte eigentlich niedrig sein
corr_globfrac = lm(x.shift.frac.glo ~ corr, data = test_data)
summary(corr_globfrac) ## 71,96 % of total variance is explained by the model
plot(corr_globfrac)
regression_corr_globfrac = ggplot(train_data, aes(y=x.shift.frac.glo, x=corr)) + geom_point() + geom_smooth(method ="lm")
regression_corr_globfrac


# highest euclidean distance of meanrepctrl and meanrepRnase
plot(x.shift.frac.glo ~ eucli, data = train_data)
cor(train_data$x.shift.frac.glo, train_data$eucli) ## sollte eigentlich niedrig sein
eucli_globfrac = lm(x.shift.frac.glo ~ eucli, data = test_data)
summary(eucli_globfrac) ## 71,96 % of total variance is explained by the model
plot(eucli_globfrac)
regression_eucli_globfrac = ggplot(train_data, aes(y=x.shift.frac.glo, x=eucli)) + geom_point() + geom_smooth(method ="lm")
regression_eucli_globfrac

## Pearson correlation is the most significant feature when predicting the x-shift of the global maximum compared to the highest euclidean distance as explanatory variable

## Plot residuals

plot(corr_globfrac)

## residuals VS fitted (predictions) should be a line
## qq plot should be a line

# test data set

prediction = predict(corr_globfrac, newdata = test_data)

sd(prediction, test_data$x.shift.frac.glo)

## avg_dis = comparison of predicted value and actual value -> very small -> good 

```

