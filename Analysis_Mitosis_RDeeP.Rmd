---
title: "Proteome-wide screen for RNA-dependent proteins_Group5_Mitosis"
author: "Katharina Lotter, Kiren Nadeem, Laura Herrfurth, Marie Lulu Salein"
date: "18 7 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analysis of mitosis data set

We start our project by analyzing the HeLa mitosis data set. The goal is to identify both RNA-binding and RNA-dependent proteins, properties they have in common and compare our results to data bases. In order to work with the data set, we have to load it first. 

```{r}
# load data set

## load data by inserting own location of data set
mFullDat <- read.table("C:/Dokumente/Uni/FS 4/Data Analysis/RDeeP_HeLa_Mitosis.csv", header = TRUE, row.names=1, sep = ";") 
## save(mFullDat, file = "mFullDat.Rdata")

load("mFullDat.Rdata") 
dim(mFullDat)
```

The data set has 7159 rows representing the proteins and 150 columns (3 replicates with 25 fractions for both control and RNase samples).

It is important that all of the values are stored as numerics. If not, this will cause problems in calculations and further analysis. As the data set contains doubles, we check every value for being stored as a double. 

```{r}
sum(apply(mFullDat, 2, is.double))
##=150 if all values are doubles
```
As we can see, all values are stored as doubles.

# Data clean-up

Our data clean-up consists of two parts: removing all rows containing all zeros and removing rows where all of the Control or the RNase values are zero. In the first step of data cleaning, we search for rows (proteins) that had only zeros. We delete this row (KLD10_HUMAN) because it does not contain any information. Thereby, the data set is reduced to 7158 rows. Next, we transformed all zeros to NA.

```{r}
which(rowSums(mFullDat==0)==150) ## proteins with all zeros
mFullDat = mFullDat[-(which(rowSums(mFullDat==0)==150)),] ## remove protein with all zeros

## replace all zeros with NA for further cleaning steps
mFullDat[mFullDat==0] = NA 
```

The data set is very large. To prepare the data for our normalization, we split the data set into smaller data frames, one data frame for each replicate resulting in 6 different data frames.

```{r}
colRep1ctrl = seq(1, 150, 6) ##all columns with measurements from rep1 control sample 
colRep2ctrl = seq(2, 150, 6) ##all columns with measurements from rep2 control sample
colRep3ctrl = seq(3, 150, 6) ##all columns with measurements from rep3 control sample
colRep1rnase = seq(4, 150, 6) ##all columns with measurements from rep1 RNase sample
colRep2rnase = seq(5, 150, 6) ##all columns with measurements from rep2 RNase sample
colRep3rnase = seq(6, 150, 6) ##all columns with measurements from rep3 RNase sample


mrep1ctrldat = mFullDat[,colRep1ctrl] 
mrep2ctrldat = mFullDat[,colRep2ctrl]
mrep3ctrldat = mFullDat[,colRep3ctrl]
mrep1rnasedat = mFullDat[,colRep1rnase]
mrep2rnasedat = mFullDat[,colRep2rnase]
mrep3rnasedat = mFullDat[,colRep3rnase]
```

Three of the six data frames are part of the control and the RNase experiments respectively. We combine them in order to get one data set for each condition by joining them per column.

```{r}
mTripCtrldat = cbind(mrep1ctrldat, mrep2ctrldat, mrep3ctrldat)
mTripRnasedat = cbind(mrep1rnasedat, mrep2rnasedat, mrep3rnasedat)
```

Now, we continue with the second step of data cleaning. A protein without any values in either the control or the RNase tests cannot be compared the other condition, thus giving us no information and can be removed. As all zeros were turned to NA in a previous step, we used is.na to look for rows - in both the control and the RNase data frame - containing all zeros (NAs). As the data sets have 75 columns, the NAs in a row without a value must sum up to 75. This step results in a data set with 7156 rows (2 proteins less). 

```{r}
mremo1 = which(rowSums(is.na(mTripCtrldat))==75)
mremo2 = which(rowSums(is.na(mTripRnasedat))==75)
if (length(mremo1) != 0) {mFullDat = mFullDat[-mremo1,]}
if (length(mremo2) != 0) {mFullDat = mFullDat[-mremo2,]}

```

# Normalization fraction-wise 

For the analysis, it is crucial that the replicates for each condition are comparable. When we look at the data set, we notice that all replicates were performed with different amounts of protein. Therefore, we perform a fraction-wise and protein-wise normalization step. First, we adapt the amount of protein per fraction for the three replicates (Ctrl and RNase separately) to be the mean of the two means lying closest to each other between the three replicates.The aim of this step is making the three replicates comparable to each other to check for the reproducibility later on. 

```{r}
## turn NA to zero
mFullDat[is.na(mFullDat)] = 0

## Ctrl sum fraction-wise before normalization to compare the protein amount between the replicates
mrep_sum = apply(mFullDat, 2, sum)

for (i in colRep1ctrl){
  barplot(mrep_sum[i:(i+2)])}

## RNase sum fraction-wise before normalization to compare the protein amount between the replicates
for (i in colRep1rnase){
  barplot(mrep_sum[i:(i+2)])
}

## vector with mean and sd for each fraction, each condition and each replicate (= 150 values)
mmean_frac_rep = apply(mFullDat, 2, mean)
msd_frac_rep = apply(mFullDat,2, sd)

## normalization fraction-wise
col_frac_per_condition = sort(c(colRep1ctrl, colRep1rnase))
mmean_rep = vector() ## vector with mean value of two mean values that are closest to each other in each fraction of each condition (comparing mean values of triplicates)
for (i in 1:50){
  a = mmean_frac_rep[col_frac_per_condition[i]]
  b = mmean_frac_rep[col_frac_per_condition[i]+1]
  c = mmean_frac_rep[col_frac_per_condition[i]+2]
  if(abs(a-b) <= abs(b-c) && abs(a-b) <= abs(a-c)){ mmean_rep[i] = mean(c(a,b))}
    else if(abs(b-c) < abs(a-b) && abs(b-c) <= abs(a-c)){mmean_rep[i] = mean(c(b,c))}
      else{mmean_rep[i] = mean(c(a,c))}
}

## normalization to mean values (stored in mean_rep)
mFullDat_fracnorm = data.frame(mFullDat)
for (i in 1:50) {
  for (j in col_frac_per_condition[i]:(col_frac_per_condition[i]+2)){
    x = mmean_rep[i]/mmean_frac_rep[j]
    mFullDat_fracnorm[,j] = mFullDat[,j]*x
    
  }
}



```

# Testing if all fraction-wise sums/means are equal after fraction-wise normalization

```{r}
## Ctrl sum fraction-wise after  normalization
mrep_sum_norm = apply(mFullDat_fracnorm, 2, sum)
for (i in colRep1ctrl){
  barplot(mrep_sum_norm[i:(i+2)])}

## RNase sum fraction-wise after normalization
for (i in colRep1rnase){
  barplot(mrep_sum_norm[i:(i+2)])
}

mrep_mean_norm = apply(mFullDat_fracnorm, 2, mean)
for (i in colRep1ctrl){
  barplot(mrep_mean_norm[i:(i+2)])}

for (i in colRep1rnase) {
  barplot(mrep_mean_norm[i:(i+2)])
}
```

# Normalization protein-wise (per replicate)

Then, we normalize the protein amount to 100 for each protein for every replicate using the apply function and saved the resulting values in six different data frames. We multiply every value with 100 divided by the sum of the protein amount replicate.

```{r}
mFullDat = mFullDat_fracnorm

mrep1ctrlnormData = t(apply(mFullDat[, colRep1ctrl], 1, function(x) x/(sum(x)/100)))
mrep2ctrlnormData = t(apply(mFullDat[, colRep2ctrl], 1, function(x) x/(sum(x)/100)))
mrep3ctrlnormData = t(apply(mFullDat[, colRep3ctrl], 1, function(x) x/(sum(x)/100)))
mrep1rnasenormData = t(apply(mFullDat[, colRep1rnase], 1, function(x) x/(sum(x)/100)))
mrep2rnasenormData = t(apply(mFullDat[, colRep2rnase], 1, function(x) x/(sum(x)/100)))
mrep3rnasenormData = t(apply(mFullDat[, colRep3rnase], 1, function(x) x/(sum(x)/100)))

mrep1ctrlnormDataframe = as.data.frame(mrep1ctrlnormData)
mrep2ctrlnormDataframe = as.data.frame(mrep2ctrlnormData)
mrep3ctrlnormDataframe = as.data.frame(mrep3ctrlnormData)
mrep1rnasenormDataframe = as.data.frame(mrep1rnasenormData)
mrep2rnasenormDataframe = as.data.frame(mrep2rnasenormData)
mrep3rnasenormDataframe = as.data.frame(mrep3rnasenormData)

## join the three replicates into two data sets (one for control, one for RNase)
mtripCtrlnormdat = cbind(mrep1ctrlnormDataframe, mrep2ctrlnormDataframe, mrep3ctrlnormDataframe)
mtripRnasenormdat = cbind(mrep1rnasenormDataframe, mrep2rnasenormDataframe, mrep3rnasenormDataframe)

## check if protein amount == 100
sum(mrep1ctrlnormData[1,]) ## == 100
```

# Creating batch-effect free data frames

Batch effects are variations in the data caused by technical factors. They are not relevant for the biological question and may even lead to different or false conclusions. Thus, we analyze the data set looking for batch-effects by comparing the values of the three replicates for each fraction and each condition:
If there is a protein that contains two zeros (NA) and one value in a fraction, the value will be set to zero.
If there is a protein showing two values and one zero, the zero is replaced by the mean of the two others.

```{r}
## turn all zeros into NA
mtripRnasenormdat[mtripRnasenormdat==0] = NA
mtripCtrlnormdat[mtripCtrlnormdat==0] = NA

for(i in 1:nrow(mtripCtrlnormdat)){
  for (j in 1:25){
    mtestctrl = c(mtripCtrlnormdat[i,j],mtripCtrlnormdat[i,j+25], mtripCtrlnormdat[i,j+50])
    if(sum(is.na(mtestctrl))==2) {
      cat("\n", i, j)
      mtripCtrlnormdat[i, j] = NA
      mtripCtrlnormdat[i, j+25] = NA
      mtripCtrlnormdat[i, j+50] = NA
    }
    if(sum(is.na(mtestctrl))==1){
      cat("\n", i, j)
      mtripCtrlnormdat[i, j] = mean(mtestctrl, na.rm = TRUE)
      mtripCtrlnormdat[i, j+25] = mean(mtestctrl, na.rm = TRUE)
      mtripCtrlnormdat[i, j+50] = mean(mtestctrl, na.rm = TRUE)
    }
  }
}

for(i in 1:nrow(mtripRnasenormdat)){
  for (j in 1:25){
    mtestrnase = c(mtripRnasenormdat[i,j],mtripRnasenormdat[i,j+25], mtripRnasenormdat[i,j+50])
    if(sum(is.na(mtestrnase))==2) {
      mtripRnasenormdat[i, j] = NA
      mtripRnasenormdat[i, j+25] = NA
      mtripRnasenormdat[i, j+50] = NA
    }
    if(sum(is.na(mtestctrl))==1){
      mtripRnasenormdat[i, j] = mean(mtestrnase, na.rm = TRUE)
      mtripRnasenormdat[i, j+25] = mean(mtestrnase, na.rm = TRUE)
      mtripRnasenormdat[i, j+50] = mean(mtestrnase, na.rm = TRUE)
    }
  }
}

## removing new rows with all zeros in control or RNase due to batch effect removal 
mna_r = which(rowSums(is.na(mtripRnasenormdat))==75)
mna_c = which(rowSums(is.na(mtripCtrlnormdat))==75)
mna_afterbatch = c(mna_r, mna_c)

if (length(mna_afterbatch) != 0) {
  mFullDat = mFullDat[-mna_afterbatch,]
  mtripCtrlnormdat = mtripCtrlnormdat[-mna_afterbatch,]
  mtripRnasenormdat = mtripRnasenormdat[-mna_afterbatch,]}

## convert all NAs back to zeros
mtripRnasenormdat[is.na(mtripRnasenormdat)] = 0
mtripCtrlnormdat[is.na(mtripCtrlnormdat)] = 0


## splitting into 6 data frames for the 6 different replicates
mrep1ctrlnormDataframe = mtripCtrlnormdat[,1:25]
mrep2ctrlnormDataframe = mtripCtrlnormdat[,26:50]
mrep3ctrlnormDataframe = mtripCtrlnormdat[,51:75]
mrep1rnasenormDataframe = mtripRnasenormdat[,1:25]
mrep2rnasenormDataframe = mtripRnasenormdat[,26:50]
mrep3rnasenormDataframe = mtripRnasenormdat[,51:75]


```
There are 14 proteins that have a replicate value being a batch effect. The issue was solved as explained before. 

# Reproducibility

It is crucial to verify that the data is reproducible. Our approach is to compare the maxima (global and local) between the replicates. We determined that maxima are allowed to differ one fraction to be reproducible. 

# Global maxima

```{r}   
## global maxima with which.max returning the highest value in the row (protein)
mfraction_abs_max = data.frame(row.names = rownames(mrep1ctrlnormDataframe))

for (i in 1:nrow(mrep1ctrlnormDataframe)){
  mfraction_abs_max[i,1] = which.max(mrep1ctrlnormDataframe[i,])
  mfraction_abs_max[i,2] = which.max(mrep2ctrlnormDataframe[i,])
  mfraction_abs_max[i,3] = which.max(mrep3ctrlnormDataframe[i,])
  mfraction_abs_max[i,4] = which.max(mrep1rnasenormDataframe[i,])
  mfraction_abs_max[i,5] = which.max(mrep2rnasenormDataframe[i,])
  mfraction_abs_max[i,6] = which.max(mrep3rnasenormDataframe[i,])
}
## mfraction_abs_max: data frame where global values are stored for each protein and each replicate (first column -> first replicate ctrl, second column -> second replicate ctrl...)

## verifying if global maximum shifts more than one fraction between the replicates (TRUE means they do not, thus reproducible)
isTRUE(all.equal(mfraction_abs_max[,1], mfraction_abs_max[,2], tolerance = 1.1))
isTRUE(all.equal(mfraction_abs_max[,2], mfraction_abs_max[,3], tolerance = 1.1))
isTRUE(all.equal(mfraction_abs_max[,1], mfraction_abs_max[,3], tolerance = 1.1))
isTRUE(all.equal(mfraction_abs_max[,4], mfraction_abs_max[,5], tolerance = 1.1))
isTRUE(all.equal(mfraction_abs_max[,5], mfraction_abs_max[,6], tolerance = 1.1))
isTRUE(all.equal(mfraction_abs_max[,4], mfraction_abs_max[,6], tolerance = 1.1))
## all global maxima are reproducible
```


# Local maxima

Definition local maxima: each of the two values right and the two values left next to the maximum are smaller than the value of the maximum and the local maximum consits of at least 3, 5 or 7% of the whole protein amount of the specific protein

For the marginal values we only look at the existing values next to them. For example, for the first fraction we only compare the protein amounts in the two fractions right to fraction 1. We had to specially implement conditions for the marginal values.

```{r}
## Threshold 3 % of total protein amount
## control
mmaxctrl1_3 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)
mmaxctrl2_3 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)
mmaxctrl3_3 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)

for (i in 1:nrow(mrep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 3 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)]){
      mmaxctrl1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 3 &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)]){
      mmaxctrl2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 3 &&  mrep3ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)]){
      mmaxctrl3_3[i,j] = j
    }
  }
 
  for(j in 2){ ## marginal value 2
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 3 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+2)]){
      mmaxctrl1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 3 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)]){
      mmaxctrl2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 3 && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+2)]){
      mmaxctrl3_3[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 3 && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+2)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-2)]) {
      mmaxctrl1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 3 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-2)]){
      mmaxctrl2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i, j] > 3 &&  mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+2)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-2)]) {
      mmaxctrl3_3[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 3 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-2)]){
      mmaxctrl1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 3 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-2)]){
      mmaxctrl2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 3 && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-2)]){
      mmaxctrl3_3[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 3 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)]){
      mmaxctrl1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 3 &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)]){
      mmaxctrl2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 3 &&  mrep3ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)]){
      mmaxctrl3_3[i,j] = j
    }
  }
}


## RNase
mmaxrnase1_3 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)
mmaxrnase2_3 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)
mmaxrnase3_3 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)

for (i in 1:nrow(mrep1rnasenormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 3 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)]){
      mmaxrnase1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 3 &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)]){
      mmaxrnase2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 3 &&  mrep3rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)]){
      mmaxrnase3_3[i,j] = j
    }
  }
 
  for(j in 2){ ## marginal value 2
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 3 &&  mrep1rnasenormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+2)]){
      mmaxrnase1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 3 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+2)]){
      mmaxrnase2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 3 && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+2)]){
      mmaxrnase3_3[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 3 && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+2)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-2)]) {
      mmaxrnase1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 3 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-2)]){
      mmaxrnase2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i, j] > 3 &&  mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+2)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-2)]) {
      mmaxrnase3_3[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 3 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-2)]){
      mmaxrnase1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 3 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-2)]){
      mmaxrnase2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 3 && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-2)]){
      mmaxrnase3_3[i,j] = j
    }
  }
  
  for (j in 25){ #marginal value 4
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 3 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)]){
      mmaxrnase1_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 3 &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)]){
      mmaxrnase2_3[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 3 &&  mrep3rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)]){
      mmaxrnase3_3[i,j] = j
    }
  }
}


## Threshold 5 % of total protein amount
## control
mmaxctrl1_5 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)
mmaxctrl2_5 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)
mmaxctrl3_5 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)

for (i in 1:nrow(mrep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 5 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)]){
      mmaxctrl1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 5 &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)]){
      mmaxctrl2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 5 &&  mrep3ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)]){
      mmaxctrl3_5[i,j] = j
    }
  }

  for(j in 2){ ## marginal value 2
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 5 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+2)]){
      mmaxctrl1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 5 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)]){
      mmaxctrl2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 5 && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+2)]){
      mmaxctrl3_5[i,j] = j
    }
  }
    
  for (j in 3:23){
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 5 && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+2)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-2)]) {
      mmaxctrl1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 5 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-2)]){
      mmaxctrl2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i, j] > 5 &&  mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+2)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-2)]) {
      mmaxctrl3_5[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 5 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-2)]){
      mmaxctrl1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 5 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-2)]){
      mmaxctrl2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 5 && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-2)]){
      mmaxctrl3_5[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 5 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)]){
      mmaxctrl1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 5 &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)]){
      mmaxctrl2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 5 &&  mrep3ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)]){
      mmaxctrl3_5[i,j] = j
    }
  }
}


## RNase
mmaxrnase1_5 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)
mmaxrnase2_5 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)
mmaxrnase3_5 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)

for (i in 1:nrow(mrep1rnasenormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 5 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)]){
      mmaxrnase1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 5 &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)]){
      mmaxrnase2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 5 &&  mrep3rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)]){
      mmaxrnase3_5[i,j] = j
    }
  }
   
  for(j in 2){ ## marginal value 2
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 5 &&  mrep1rnasenormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+2)]){
      mmaxrnase1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 5 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+2)]){
      mmaxrnase2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 5 && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+2)]){
      mmaxrnase3_5[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 5 && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+2)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-2)]) {
      mmaxrnase1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 5 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-2)]){
      mmaxrnase2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i, j] > 5 &&  mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+2)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-2)]) {
      mmaxrnase3_5[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 5 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-2)]){
      mmaxrnase1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 5 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-2)]){
      mmaxrnase2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 5 && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-2)]){
      mmaxrnase3_5[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 5 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)]){
      mmaxrnase1_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 5 &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)]){
      mmaxrnase2_5[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 5 &&  mrep3rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)]){
      mmaxrnase3_5[i,j] = j
    }
  }
}


## Threshold 7 % of total protein amount
## control
mmaxctrl1_7 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)
mmaxctrl2_7 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)
mmaxctrl3_7 = matrix(0, nrow=nrow(mrep1ctrlnormDataframe), ncol=25)

for (i in 1:nrow(mrep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 7 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)]){
      mmaxctrl1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 7 &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)]){
      mmaxctrl2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 7 &&  mrep3ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)]){
      mmaxctrl3_7[i,j] = j
    }
  }
  
  for(j in 2){ ## marginal value 2
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 7 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+2)]){
      mmaxctrl1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 7 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)]){
      mmaxctrl2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 7 && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+2)]){
      mmaxctrl3_7[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 7 && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+2)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-2)]) {
      mmaxctrl1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 7 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-2)]){
      mmaxctrl2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i, j] > 7 &&  mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+2)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-2)]) {
      mmaxctrl3_7[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 7 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-2)]){
      mmaxctrl1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 7 && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+1)] &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-2)]){
      mmaxctrl2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 7 && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j+1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-1)] && mrep3ctrlnormDataframe[i,j] > mrep3ctrlnormDataframe[i, (j-2)]){
      mmaxctrl3_7[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != mfraction_abs_max[i,1] && mrep1ctrlnormDataframe[i,j] > 7 &&  mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)]){
      mmaxctrl1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,2] && mrep2ctrlnormDataframe[i,j] > 7 &&  mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j-1)]){
      mmaxctrl2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,3] && mrep3ctrlnormDataframe[i,j] > 7 &&  mrep3ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)]){
      mmaxctrl3_7[i,j] = j
    }
  }
}

## RNase
mmaxrnase1_7 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)
mmaxrnase2_7 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)
mmaxrnase3_7 = matrix(0, nrow=nrow(mrep1rnasenormDataframe), ncol=25)

for (i in 1:nrow(mrep1rnasenormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 7 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)]){
      mmaxrnase1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 7 &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)]){
      mmaxrnase2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 7 &&  mrep3rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)]){
      mmaxrnase3_7[i,j] = j
    }
  }
   
  for(j in 2){ ## marginal value 2
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 7 &&  mrep1rnasenormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j-1)] && mrep1ctrlnormDataframe[i,j] > mrep1ctrlnormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+2)]){
      mmaxrnase1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 7 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+2)]){
      mmaxrnase2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 7 && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+2)]){
      mmaxrnase3_7[i,j] = j
    }
  }
  
  for (j in 3:23){
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 7 && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+2)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-2)]) {
      mmaxrnase1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 7 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] && mrep2ctrlnormDataframe[i,j] > mrep2ctrlnormDataframe[i, (j+2)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-2)]){
      mmaxrnase2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i, j] > 7 &&  mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+2)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-2)]) {
      mmaxrnase3_7[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 7 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j+1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)] && mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-2)]){
      mmaxrnase1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 7 && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j+1)] &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)] && mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-2)]){
      mmaxrnase2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 7 && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j+1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-1)] && mrep3rnasenormDataframe[i,j] > mrep3rnasenormDataframe[i, (j-2)]){
      mmaxrnase3_7[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != mfraction_abs_max[i,4] && mrep1rnasenormDataframe[i,j] > 7 &&  mrep1rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)]){
      mmaxrnase1_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,5] && mrep2rnasenormDataframe[i,j] > 7 &&  mrep2rnasenormDataframe[i,j] > mrep2rnasenormDataframe[i, (j-1)]){
      mmaxrnase2_7[i,j] = j
    }
    if(j != mfraction_abs_max[i,6] && mrep3rnasenormDataframe[i,j] > 7 &&  mrep3rnasenormDataframe[i,j] > mrep1rnasenormDataframe[i, (j-1)]){
      mmaxrnase3_7[i,j] = j
    }
  }
}

## Now we have three data sets for the different thresholds which contain only zeros except on the positions where we found a maximum

## Comparison thresholds
## matrix that is TRUE if local maximum shifted at least two fractions, otherwise FALSE
compare_max = function(a,b){
vgl = matrix(FALSE, ncol = 25, nrow = nrow(mrep1ctrlnormDataframe))
row.names(vgl) = rownames(mrep1ctrlnormDataframe)
truesum = vector()
for (i in 1:nrow(vgl)){
  
  for (j in 1) {
    if(a[i,j]==b[i,j]){
    } 
    else if(a[i,j]==0 && b[i,j]!=0){
        if(a[i,(j+1)] != 0){
        }
          else {vgl[i,j] = TRUE}
      }
    else if(a[i,j]!=0 && b[i,j]==0){
        if(b[i,(j+1)] != 0){
        }
           else {vgl[i,j] = TRUE}
      }
  }
  
  for (j in 2:24){
    if(a[i,j]==b[i,j]){
      } 
    else if(a[i,j]==0 && b[i,j]!=0){
        if(a[i,(j+1)] != 0 || a[i,(j-1)] != 0){
        }
          else {vgl[i,j] = TRUE}
      }
    else if(a[i,j]!=0 && b[i,j]==0){
        if(b[i,(j+1)] != 0 || b[i,(j-1)] != 0){
        }
           else {vgl[i,j] = TRUE}
      }
  }
  
  for (j in 25) {
    if(a[i,j]==b[i,j]){
    } 
    else if(a[i,j]==0 && b[i,j]!=0){
        if(a[i,(j-1)] != 0){
        }
          else {vgl[i,j] = TRUE}
      }
    else if(a[i,j]!=0 && b[i,j]==0){
        if(b[i,(j-1)] != 0){
        }
           else {vgl[i,j] = TRUE}
      }
  }
  
  truesum[i] = sum(vgl[i,]) 
}

return(truesum)
}

## compare_max returns vector that tells for each protein how many maxima are more than one fraction different between the compared data frames

compare_max(mmaxctrl2_3, mmaxctrl3_3)
comp_rep = function(a,b,c){

rows_rep = vector()
rows_rep = compare_max(a, b)
rows_rep = cbind(rows_rep, compare_max(a,c))
rows_rep = cbind(rows_rep, compare_max(b,c))
row.names(rows_rep) = rownames(mrep1ctrlnormDataframe)

return(rows_rep)
}

## matrix with number of at least one fraction local maxima differences for comparison of each two replicates out of three (different thresholds of total protein amount 3%, 5%, 7%)
mloc_max_ctrl3 = as.data.frame(comp_rep(mmaxctrl1_3, mmaxctrl2_3, mmaxctrl3_3))
mloc_max_ctrl5 = as.data.frame(comp_rep(mmaxctrl1_5, mmaxctrl2_5, mmaxctrl3_5))
mloc_max_ctrl7 = as.data.frame(comp_rep(mmaxctrl3_3, mmaxctrl3_5, mmaxctrl3_7))
mloc_max_rnase3 = as.data.frame(comp_rep(mmaxrnase1_3, mmaxrnase2_3, mmaxrnase3_3))
mloc_max_rnase5 = as.data.frame(comp_rep(mmaxrnase1_5, mmaxrnase2_5, mmaxrnase3_5))
mloc_max_rnase7 = as.data.frame(comp_rep(mmaxrnase1_7, mmaxrnase2_7, mmaxrnase3_7))


## counting proteins that show at least one fraction shift when comparing all replicates in Ctrl and/or RNase 
not_repro = function(a,b) {
  u = vector()
  for (i in 1:nrow(mloc_max_ctrl3)) {
    if ((a[i,1] != 0 && a[i,2] != 0 && a[i,3] != 0) || (b[i,1] != 0 && b[i,2] != 0 && b[i,3] != 0)){
      u[i] = TRUE
      }
          else {u[i] = FALSE}
  }
return(u)
}

  
mthres_3 = not_repro(mloc_max_ctrl3, mloc_max_rnase3)
sum(mthres_3) ## we would remove 594 proteins with threshold 3%
mthres_5 = not_repro(mloc_max_ctrl5, mloc_max_rnase5)
sum(mthres_5) ## we would remove 498 proteins with threshold 5%
mthres_7 = not_repro(mloc_max_ctrl7, mloc_max_rnase7)
sum(mthres_7) ## we would remove 303 proteins with threshold 7% 

## we decide to go with maximum has to contain at least 5 % of total protein amount
## remove proteins that are not reproducible from all data sets
mFullDat = mFullDat[- which(mthres_5 == TRUE),]
mrep1ctrlnormDataframe = mrep1ctrlnormDataframe[- which(mthres_5 == TRUE),]
mrep2ctrlnormDataframe = mrep2ctrlnormDataframe[- which(mthres_5 == TRUE),]
mrep3ctrlnormDataframe = mrep3ctrlnormDataframe[- which(mthres_5 == TRUE),]
mrep1rnasenormDataframe = mrep1rnasenormDataframe[- which(mthres_5 == TRUE),]
mrep2rnasenormDataframe = mrep2rnasenormDataframe[- which(mthres_5 == TRUE),]
mrep3rnasenormDataframe = mrep3rnasenormDataframe[- which(mthres_5 == TRUE),]
mtripCtrlnormdat = mtripCtrlnormdat[- which(mthres_5==TRUE),]
mtripRnasenormdat = mtripRnasenormdat[- which(mthres_5==TRUE),]

```

# Mean curves

The next step is taking the mean of all three replicates for each condition to receive an average curve of the protein's distribution with and without RNase. Our normalization has the advantage that all values of the resulting curve sum up to 100. Thus, they are interpretable as percentages.  

```{r}
## mean of control replicates of all proteins  
mmeanRepctrl = matrix(nrow= nrow(mFullDat), ncol = 25)
for (j in 1:nrow(mFullDat)){ 
  for (i in 1:25){
    mmeanRepctrl[j,i] = (mrep1ctrlnormDataframe[j,i] + mrep2ctrlnormDataframe[j,i] + mrep3ctrlnormDataframe[j,i])/3}}

## mean of rnase replicates of all proteins 
mmeanRepRNase = matrix(nrow= nrow(mFullDat), ncol = 25)
for (j in 1:nrow(mFullDat)){ 
  for (i in 1:25){
    mmeanRepRNase[j,i] = (mrep1rnasenormDataframe[j,i] + mrep2rnasenormDataframe[j,i] + mrep3rnasenormDataframe[j,i])/3}}


```

Now we have two curves for the two conditions. Our goal is to determine the maxima and find out which proteins are shifting. This is why we plot the two curves of RNase (pink) and control (blue) in one graph. As we can see, the graphs of the first 10 proteins does not show a shift. 

```{r} 
y = 1:25

for (i in 1:10){
  plot(y, mmeanRepctrl[i,], type ="o", pch = 20, ylab = "percentage of protein amount", xlab = "fractions of sucrose density gradient", col = "cyan")
  lines(y,mmeanRepRNase[i,], type = "o", pch = 20, col = "magenta")
}


```
# Maxima for mean Ctrl and mean RNase values

Both global and local maxima of the averged curves are calculated as described in the reproducibility part.

# Global maxima

```{r}
## calculating global maxima
mabs_max = data.frame(row.names = rownames(mrep1ctrlnormDataframe))

for (i in 1:nrow(mrep1ctrlnormDataframe)){
  mabs_max[i,1] = which.max(mmeanRepctrl[i,])
  mabs_max[i,2] = which.max(mmeanRepRNase[i,])
  
}

mabs_max$compare = ifelse(abs(mabs_max$V1-mabs_max$V2) > 1, TRUE, FALSE)
sum(mabs_max$compare)
## there are 1045 proteins whose global maximum shifts at least 2 fractions (x-shift)
mabs_max_shift = rownames (mabs_max) [mabs_max$compare==TRUE] ## proteins x-shifting in global maximum
```

# Local maxima

```{r}

## calculating local maxima
mmax_shift_ctrl = matrix(0, nrow = nrow(mrep1ctrlnormDataframe), ncol = 25)
mmax_shift_rnase = matrix(0, nrow = nrow(mrep1ctrlnormDataframe), ncol = 25)

for (i in 1:nrow(mrep1ctrlnormDataframe)){
  
  for (j in 1){ ## marginal value 1
    if(j != mabs_max[i,1] && mmeanRepctrl[i,j] > 5 &&  mmeanRepctrl[i,j] > mmeanRepctrl[i, (j+1)]){
      mmax_shift_ctrl[i,j] = j
    }
    if(j != mabs_max[i,2] && mmeanRepRNase[i,j] > 5 && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j+1)]){
      mmax_shift_rnase[i,j] = j
    }
  }

  for(j in 2){ ## marginal value 2
    if(j != mabs_max[i,1] && mmeanRepctrl[i,j] > 5 &&  mmeanRepctrl[i,j] > mmeanRepctrl[i, (j-1)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j+1)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j+2)]){
      mmax_shift_ctrl[i,j] = j
    }
    if(j != mabs_max[i,2] && mmeanRepRNase[i,j] > 5 && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j-1)] &&  mmeanRepRNase[i,j] > mmeanRepRNase[i, (j+1)] && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j+2)]){
      mmax_shift_rnase[i,j] = j
    }
  }

  for (j in 3:23){
    if(j != mabs_max[i,1] && mmeanRepctrl[i,j] > 5 && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j-1)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j+1)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j+2)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j-2)]) {
      mmax_shift_ctrl[i,j] = j
    }
    if(j != mabs_max[i,2] && mmeanRepRNase[i,j] > 5 && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j-1)] && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j+1)] && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j+2)] && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j-2)]){
      mmax_shift_rnase[i,j] = j
    }
  }
  
  for(j in 24){ ## marginal value 3
    if(j != mabs_max[i,1] && mmeanRepctrl[i,j] > 5 &&  mmeanRepctrl[i,j] > mmeanRepctrl[i, (j+1)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j-1)] && mmeanRepctrl[i,j] > mmeanRepctrl[i, (j-2)]){
      mmax_shift_ctrl[i,j] = j
    }
    if(j != mabs_max[i,2] && mmeanRepRNase[i,j] > 5 && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j+1)] &&  mmeanRepRNase[i,j] > mmeanRepRNase[i, (j-1)] && mmeanRepRNase[i,j] > mmeanRepRNase[i, (j-2)]){
      mmax_shift_rnase[i,j] = j
    }
  }
  
  for (j in 25){ ## marginal value 4
    if(j != mabs_max[i,1] && mmeanRepctrl[i,j] > 5 &&  mmeanRepctrl[i,j] > mmeanRepctrl[i, (j-1)]){
      mmax_shift_ctrl[i,j] = j
    }
    if(j != mabs_max[i,2] && mmeanRepRNase[i,j] > 5 &&  mmeanRepRNase[i,j] > mmeanRepRNase[i, (j-1)]){
      mmax_shift_rnase[i,j] = j
    }
  }
}

mcount_shift = compare_max(mmax_shift_ctrl, mmax_shift_rnase)
length(which(mcount_shift!=0))
mloc_max_shift = rownames(mrep1ctrlnormDataframe)[which(mcount_shift!=0)] ## x-shift

## compare x-shifts in absolute and local maxima as there are proteins shifting in both

mid = vector()
for (i in 1:length(mloc_max_shift)) {
  j = 1
  for(j in 1:length(mabs_max_shift)){
    if(mloc_max_shift[i]!=mabs_max_shift[j]){
      mid[i] = FALSE
    }
      else if (mloc_max_shift[i]==mabs_max_shift[j]) {
        mid[i] = TRUE
        break
      }
  }
}
sum(mid) ## 772 proteins are both found in absolute and local maxima shifts
mloc_max_shift = mloc_max_shift[- which(mid==TRUE)] ## mloc_max_shift are all proteins shifting in local maximum excluded those also shifting in global maximum (783)

## number of shifting proteins
sum(mid)+(length(mabs_max_shift)-sum(mid))+length(mloc_max_shift) ## 1828 proteins have a shift and might be RNA-binding or RNA-dependent

```
We find 1828 proteins shifting in their global and/or local maxima. In the following, we test if the shift in protein amount is significant which would result in classifying the protein as an RNA-binding or RNA-dependent protein. 

# t-test of shift of protein amount for maximum verification (y-shift)

# Global maximum 

```{r}
## calculating global maxima
mabs_max_yc = vector()
mabs_max_yr = vector()
## two vectors (control and RNase) containing the y-value (protein amount) of the global maximum
for (i in 1:nrow(mabs_max)) {
  mabs_max_yc[i] = mmeanRepctrl[i, mabs_max[i,1]]
  mabs_max_yr[i] = mmeanRepRNase[i, mabs_max[i,2]]
}

## add vectors as new column to global maxima data frame (mabs_max)
mabs_max$ymaxc = mabs_max_yc
mabs_max$ymaxr = mabs_max_yr

## vector ml contains p-value for each global maximum with a shift (mabs_max[i,3] == TRUE), otherwise for distinction random number larger than 1 (10)
ml = vector()
for (i in 1:nrow(mabs_max)) { 
  if(mabs_max[i,3]==TRUE) {
    fc = mabs_max[i,1]
    ml[i] = t.test(c(mtripCtrlnormdat[i,fc], mtripCtrlnormdat[i, (fc+25)], mtripCtrlnormdat[i, (fc+50)]), c(mtripRnasenormdat[i,fc], mtripRnasenormdat[i, (fc+25)], mtripRnasenormdat[i, (fc+50)]), alternative = "two.sided")$p.value
  }
    else {ml[i] = 10} ## random value chosen larger than 1
}

mabs_max$pvalue = ml
mabs_max$sign = ifelse(mabs_max$pvalue >= 0.025, FALSE, TRUE) ## 0.025 due to two-sided t-test
sum(mabs_max$sign) ## how many proteins have a significant shift in protein amount in their global maximum (641 out of 6665)

colnames(mabs_max)[1] = "m.global_max_ctrl"
colnames(mabs_max)[2] = "m.global_max_rnase"
mproteins_global_shift = data.frame(mabs_max[(which(mabs_max$sign == TRUE)),]) ## data frame containing all proteins that shift in global maximum before fdr-correction

## create new column containing fdr corrected p-value
mproteins_global_shift$p_adjusted = p.adjust(mproteins_global_shift$pvalue, method = "fdr")
mproteins_global_shift$sign_ad = ifelse(mproteins_global_shift$p_adjusted >= 0.025, FALSE, TRUE)
sum(mproteins_global_shift$sign_ad) ## all 641 proteins with shift identified are still significant after fdr-correction

## create new column containing information about right or left shift (difference of control and RNase global maximum fractions)
mproteins_global_shift$leftorright = ifelse(mproteins_global_shift$m.global_max_ctrl < mproteins_global_shift$m.global_max_rnase, "right", "left")
```

# Local maxima

```{r}
## calculating local maxima
## generate matrices for statistical testing of local maxima 
mp_loc_max = matrix(10, ncol = 25, nrow = nrow(mrep1ctrlnormDataframe)) ## matrix for adjusted p-values
row.names(mp_loc_max) = rownames(mrep1ctrlnormDataframe)
mp_loc_shift = vector(length = nrow(mrep1ctrlnormDataframe)) ## vector distinguish significant and not significant y-shift
msign_loc_shiftc = matrix(0, ncol = 25, nrow = nrow(mrep1ctrlnormDataframe)) ## matrix for fractions of shifting local maximum
msign_loc_shiftr = matrix(0, ncol = 25, nrow = nrow(mrep1ctrlnormDataframe)) ## matrix for fractions of shfiting local maximum

for (i in 1:nrow(mp_loc_max)) {
  if(mcount_shift[i] > 0){  
    for (j in 1) {
      if(mmax_shift_ctrl[i,j]==mmax_shift_rnase[i,j]){
          
      } else if(mmax_shift_ctrl[i,j]==0 && mmax_shift_rnase[i,j]!=0){
          if(mmax_shift_ctrl[i,(j+1)] != 0){
          }
            else {
              msign_loc_shiftr[i,j] = j
              mp_loc_max[i,j] = t.test(c(mtripCtrlnormdat[i,j], mtripCtrlnormdat[i, (j+25)], mtripCtrlnormdat[i, (j+50)]), c(mtripRnasenormdat[i,j], mtripRnasenormdat[i, (j+25)], mtripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
              mp_loc_max[i,j] = p.adjust(mp_loc_max[i,j], method = "fdr")
              if(mp_loc_max[i,j] < 0.025) { mp_loc_shift[i]=TRUE }
              }
        }
        else if(mmax_shift_ctrl[i,j]!=0 && mmax_shift_rnase[i,j]==0){
          if(mmax_shift_rnase[i,(j+1)] != 0){
          }
             else {
               msign_loc_shiftc[i,j] = j
               mp_loc_max[i,j] = t.test(c(mtripCtrlnormdat[i,j], mtripCtrlnormdat[i, (j+25)], mtripCtrlnormdat[i, (j+50)]), c(mtripRnasenormdat[i,j], mtripRnasenormdat[i, (j+25)], mtripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
               mp_loc_max[i,j] = p.adjust(mp_loc_max[i,j], method = "fdr")
               if(mp_loc_max[i,j] < 0.025) { mp_loc_shift[i]=TRUE }
                 }
        }
    }
    
    for (j in 2:24){
      if(mmax_shift_ctrl[i,j]==mmax_shift_rnase[i,j]){
         
      } else if(mmax_shift_ctrl[i,j]==0 && mmax_shift_rnase[i,j]!=0){
          if(mmax_shift_ctrl[i,(j+1)] != 0 || mmax_shift_ctrl[i,(j-1)] != 0){
          }
            else {
              msign_loc_shiftr[i,j] = j
              mp_loc_max[i,j] = t.test(c(mtripCtrlnormdat[i,j], mtripCtrlnormdat[i, (j+25)], mtripCtrlnormdat[i, (j+50)]), c(mtripRnasenormdat[i,j], mtripRnasenormdat[i, (j+25)], mtripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
              mp_loc_max[i,j] = p.adjust(mp_loc_max[i,j], method = "fdr")
              if(mp_loc_max[i,j] < 0.025) { mp_loc_shift[i]=TRUE }
            }
        }
        else if(mmax_shift_ctrl[i,j]!=0 && mmax_shift_rnase[i,j]==0){
          if(mmax_shift_rnase[i,(j+1)] != 0 || mmax_shift_rnase[i,(j-1)] != 0){
          }
             else {
               msign_loc_shiftc[i,j] = j
               mp_loc_max[i,j] = t.test(c(mtripCtrlnormdat[i,j], mtripCtrlnormdat[i, (j+25)], mtripCtrlnormdat[i, (j+50)]), c(mtripRnasenormdat[i,j], mtripRnasenormdat[i, (j+25)], mtripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
               mp_loc_max[i,j] = p.adjust(mp_loc_max[i,j], method = "fdr")
               if(mp_loc_max[i,j] < 0.025) { mp_loc_shift[i]=TRUE }
             }
        }
    }
    
    for (j in 25) {
      if(mmax_shift_ctrl[i,j]==mmax_shift_rnase[i,j]){
          
      } else if(mmax_shift_ctrl[i,j]==0 && mmax_shift_rnase[i,j]!=0){
          if(mmax_shift_ctrl[i,(j-1)] != 0){
          }
            else {
              msign_loc_shiftr[i,j] = j
              mp_loc_max[i,j] = t.test(c(mtripCtrlnormdat[i,j], mtripCtrlnormdat[i, (j+25)], mtripCtrlnormdat[i, (j+50)]), c(mtripRnasenormdat[i,j], mtripRnasenormdat[i, (j+25)], mtripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
              mp_loc_max[i,j] = p.adjust(mp_loc_max[i,j], method = "fdr")
              if(mp_loc_max[i,j] < 0.025) { mp_loc_shift[i]=TRUE }
            }
        }
        else if(mmax_shift_ctrl[i,j]!=0 && mmax_shift_rnase[i,j]==0){
          if(mmax_shift_rnase[i,(j-1)] != 0){
          }
             else {
               msign_loc_shiftc[i,j] = j
               mp_loc_max[i,j] = t.test(c(mtripCtrlnormdat[i,j], mtripCtrlnormdat[i, (j+25)], mtripCtrlnormdat[i, (j+50)]), c(mtripRnasenormdat[i,j], mtripRnasenormdat[i, (j+25)], mtripRnasenormdat[i, (j+50)]), alternative = "two.sided")$p.value
               mp_loc_max[i,j] = p.adjust(mp_loc_max[i,j], method = "fdr")
               if(mp_loc_max[i,j] < 0.025) { mp_loc_shift[i]=TRUE }
             }
        }
    }
  }    
}
## mp_loc_shift if TRUE y-shift in local maximum is significant

mp_loc_max = as.data.frame(mp_loc_max) ## data frame with all 10 only at shifting position adjusted p-value
mp_loc_max$count = mcount_shift
mproteins_local_shift = mp_loc_max[which(mp_loc_shift==TRUE),] ## proteins that shift in local maximum
dim(mproteins_local_shift) ## 1471 proteins shift in local maximum
mproteins_local_shift = cbind(rownames(mproteins_local_shift), mproteins_local_shift)
colnames(mproteins_local_shift)[1] = "protein"


mproteins_global_shift = cbind(rownames(mproteins_global_shift), mproteins_global_shift)
colnames(mproteins_global_shift)[1] = "protein"
mproteins_both_shift = merge(mproteins_global_shift, mproteins_local_shift, by = "protein") ## data sets merged by protein names (column "protein")
mproteins_both_shift = mproteins_both_shift[,-(11:36)]
dim(mproteins_both_shift) ## 687 proteins shift in both global and local maximum
mproteins_shifting = merge(mproteins_global_shift, mproteins_local_shift, by = "protein", all = TRUE) ## 1244 proteins have a shift in either local and/or global maximum
mproteins_shifting = mproteins_shifting[,-(12:36)]

mproteins_shifting$glo_loc = ifelse(is.na(mproteins_shifting[,11]), "only local", "global")
mproteins_shifting$sign_ad[is.na(mproteins_shifting$sign_ad)] = 0
mproteins_shifting$count[is.na(mproteins_shifting$count)] = 0
mproteins_shifting$mcount_shift = ifelse(mproteins_shifting$sign_ad == 1, (mproteins_shifting$count +1), mproteins_shifting$count)

## install.packages(dplyr) if necessary
library(dplyr)
mproteins_only_global = anti_join(mproteins_global_shift, mproteins_both_shift, by = "protein") 
nrow(mproteins_only_global) ## 163 proteins only shift in global maximum
mproteins_only_local = anti_join(mproteins_local_shift, mproteins_both_shift, by = "protein") 
nrow(mproteins_only_local) ## 603 proteins only shift in local maximum

```

# Data set preparation for k-means

```{r}
## build overview_mi data frame with possibly useful information of previous analysis
## vectors with number of maxima
mnumb_max_ctrl = rowSums(mmax_shift_ctrl!=0)+1 ## +1 -> plus global maximum
mnumb_max_rnase = rowSums(mmax_shift_rnase!=0)+1 ## +1 -> plus global maximum

## add to mabs_max data frame
mabs_max$max_ctrl = mnumb_max_ctrl
mabs_max$max_rnase = mnumb_max_rnase
mabs_max$shift = ifelse(mp_loc_shift == TRUE | mabs_max$sign == TRUE, "shift", "no shift") 


# anzahl maxima und anzahl shift gegen shift in haupt, haupt+neben oder nur nebenmaximum

overview_mi = cbind(mabs_max[, c(1,2,3,4,5,7,8,9,10)], mcount_shift, mp_loc_shift)
colnames(overview_mi)[3] = "m.x.shift.glo" ## TRUE/FALSE significant x-shift in global maximum
colnames(overview_mi)[6] = "m.y.shift.glo" ## TRUE/FALSE significant y-shift in global maximum
colnames(overview_mi)[9] = "m.no.shift?" ## "shift" or "no shift"
colnames(overview_mi)[10] = "m.count.x.shift.loc" ## how many local maxima shift
colnames(overview_mi)[11] = "m.y.shift.loc" ## TRUE/FALSE significant y-shift at least one local maximum
colnames(overview_mi)[4] = "m.ymaxc" ## y-value of global maximum of mean control
colnames(overview_mi)[5] = "m.ymaxr" ## y-value of global maximum of mean RNase
colnames(overview_mi)[7] = "m.max_ctrl" ## number of maxima in mean control
colnames(overview_mi)[8] = "m.max_rnase" ## number of maxima in mean RNase
overview_mi$m.x.shift.loc = ifelse(overview_mi$m.count.x.shift.loc != 0, TRUE, FALSE) ## TRUE/FALSE significant x-shift in local maximum
overview_mi$m.x.loc.glo = ifelse(overview_mi$m.x.shift.glo == TRUE & overview_mi$m.x.shift.loc == TRUE, TRUE, FALSE) ## TRUE/FALSE significant x-shift in global and/or local maximum
overview_mi$m.y.loc.glo = ifelse(overview_mi$m.y.shift.glo == TRUE & overview_mi$m.y.shift.loc == TRUE, TRUE, FALSE) ## TRUE/FALSE significant y-shift in global and/or local maximum

## "right" if right shift in global maximum, "left" if left shift in global maximum, "shift" if shift only in local maximum, "no shift" if no shift
overview_mi$m.left.right = ifelse(overview_mi$m.x.shift.glo == TRUE & overview_mi$m.global_max_ctrl - overview_mi$m.global_max_rnase > 0, "left", "no shift") 
overview_mi$m.left.right = ifelse(overview_mi$m.left.right != "left" & overview_mi$m.x.shift.glo == TRUE & overview_mi$m.global_max_ctrl - overview_mi$m.global_max_rnase < 0, "right", overview_mi$m.left.right)
overview_mi$m.left.right = ifelse(overview_mi$m.x.shift.glo == FALSE & overview_mi$m.x.shift.loc == TRUE, "shift", overview_mi$m.left.right)
overview_mi$m.x.shift.frac.glo = overview_mi$m.global_max_ctrl - overview_mi$m.global_max_rnase ## difference in fraction of global maximum between control and RNase
overview_mi$m.count.shift = ifelse(overview_mi$m.x.shift.glo == TRUE, overview_mi$m.count.x.shift.loc + 1, overview_mi$m.count.x.shift.loc)

## create column with protein names
overview_mi$protein = rownames(overview_mi)

## compute correlation between control and RNase mean curve for each protein and store in mcor_merge
mcor_merge = vector()
for(i in 1:nrow(mmeanRepctrl)){
  mcor_merge[i] = cor(mmeanRepctrl[i,], mmeanRepRNase[i,])
}
overview_mi$m.corr = mcor_merge

```


